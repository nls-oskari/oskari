(function(){function c(){return l}var e=this,t=!1,n=window.console!=null&&window.console.debug,s=function(e){if(!t)return;if(!n)return;window.console.debug(e)},o=function(){this.lang=null,this.localizations={}};o.prototype={setLocalization:function(e,t,n){this.localizations[e]||(this.localizations[e]={}),this.localizations[e][t]=n},setLang:function(e){this.lang=e},getLang:function(){return this.lang},getLocalization:function(e){return this.localizations[this.lang][e]}};var u=new o,a=!1,f="default",l=!0,h=function(){this.packages={},this.protocols={},this.inheritance={},this.aspects={},this.clazzcache={},this.globals={}};h.prototype={purge:function(){},protocol:function(){var e=arguments;if(e.length==0)throw"missing arguments";return this.protocols[e[0]]},pdefsp:function(e){var t=this.clazzcache[e],n=null,r=null,i=null;if(!t){var s=e.split("."),n=s[0],r=s[1],i=s.slice(2).join("."),o=this.packages[r];o||(o={},this.packages[r]=o),t=o[i],this.clazzcache[e]=t}return t},metadata:function(){var e=arguments;if(e.length==0)throw"missing arguments";var t=e[0],n=this.pdefsp(t);if(!n)throw"clazz "+t+" does not exist";return n._metadata},updateMetadata:function(e,t,n,r,i){r._metadata||(r._metadata={}),r._metadata.meta=i;var s=i.protocol;if(s)for(var o=0;o<s.length;o++){var u=s[o];this.protocols[u]||(this.protocols[u]={});var a=e+"."+t+"."+n;this.protocols[u][a]=r}},_super:function(){var e=arguments[0],t=arguments[1],n=this;return function(){return n._._superCategory[e][t].apply(n,arguments)}},define:function(){var e=arguments;if(e.length==0)throw"missing arguments";var t=e[0],n=t.split("."),r=n[0],i=n[1],s=n.slice(2).join("."),o=this.packages[i];o||(o={},this.packages[i]=o);var u=o[s];if(u){e[1]&&(u._constructor=e[1]);var a=e[2],f=u._class.prototype;for(p in a){var l=a[p];f[p]=l}var c=t;a&&(u._category[c]=a);if(e.length>3){var h=e[3].extend;for(var d=0;h&&d<h.length;d++){var v=this.lookup(h[d]);v._composition.subClazz||(v._composition.subClazz={}),v._composition.subClazz[h[d]]=u,u._composition.superClazz=v}this.updateMetadata(r,i,s,u,e[3])}return this.pullDown(u),this.pushDown(u),u}var m=function(){},g={clazzName:t,superClazz:null,subClazz:null};m.prototype={},u={_class:m,_constructor:e[1],_category:{},_composition:g},m.prototype._=u,m.prototype._super=this._super;var a=e[2],f=m.prototype;for(p in a){var l=a[p];f[p]=l}var c=t;a&&(u._category[c]=a),this.inheritance[t]=g,o[s]=u;if(e.length>3){var h=e[3].extend;for(var d=0;h&&d<h.length;d++){var v=this.lookup(h[d]);v._composition.subClazz||(v._composition.subClazz={}),v._composition.subClazz[t]=u,u._composition.superClazz=v}this.updateMetadata(r,i,s,u,e[3])}return this.pullDown(u),this.pushDown(u),u},category:function(){var e=arguments;if(e.length==0)throw"missing arguments";var t=e[0],n=t.split("."),r=n[0],i=n[1],s=n.slice(2).join("."),o=this.packages[i];o||(o={},this.packages[i]=o);var u=o[s];if(!u){var a=function(){},f={clazzName:t,superClazz:null,subClazz:null};a.prototype={},u={_class:a,_constructor:e[1],_category:{},_composition:f},a.prototype._=u,a.prototype._super=this._super,this.inheritance[t]=f,o[s]=u}var l=e[1],c=e[2],h=u._class.prototype;for(p in c){var d=c[p];h[p]=d}return c&&(u._category[l]=c),this.pullDown(u),this.pushDown(u),u},lookup:function(){var e=arguments;if(e.length==0)throw"missing arguments";var t=e[0],n=t.split("."),r=n[0],i=n[1],s=n.slice(2).join("."),o=this.packages[i];o||(o={},this.packages[i]=o);var u=o[s];if(!u){var a=function(){};a.prototype={};var f={clazzName:t,superClazz:null,subClazz:null};u={_class:a,_constructor:e[1],_category:{},_composition:f},this.inheritance[t]=f,o[s]=u}return u},extend:function(){var e=arguments,t=this.lookup(e[1]),n=this.lookup(e[0]);return t._composition.subClazz||(t._composition.subClazz={}),t._composition.subClazz[e[0]]=n,n._composition.superClazz=t,this.pullDown(n),n},composition:function(){var e=arguments[0],t=this.pdefsp(e);return t},pushDown:function(e){if(!e._composition.subClazz)return;for(var t in e._composition.subClazz){var n=e._composition.subClazz[t];this.pullDown(n),this.pushDown(n)}return e},pullDown:function(e){if(!e._composition.superClazz)return;var t=[];t.push(e);var n={},r=e;for(;;){r=r._composition.superClazz;if(!r)break;t.push(r)}var i=e._class.prototype,s=[],o={};for(var u=t.length-1;u>=0;u--){var a=t[u]._composition.clazzName,f=t[u]._constructor;s.push(f);var l={};for(var c in t[u]._category){var h=a+"#"+c,d=t[u]._category[c];for(p in d){var v=d[p];i[p]=v,l[p]=v}}o[a]=l}return e._constructors=s,e._superCategory=o,e},slicer:Array.prototype.slice,create:function(){var e=arguments;if(e.length==0)throw"missing arguments";var t=this.slicer.apply(arguments,[1]),n=e[0],r=this.pdefsp(n);if(!r)throw"clazz "+n+" does not exist";var i=new r._class,s=r._constructors;if(s)for(var o=0;o<s.length;o++)s[o].apply(i,t);else r._constructor.apply(i,t);return i},createWithPdefsp:function(){var e=arguments;if(e.length==0)throw"missing arguments";var t=arguments[1],n=e[0];if(!n)throw"clazz does not exist";var r=new n._class,i=n._constructors;if(i)for(var s=0;s<i.length;s++)i[s].apply(r,t);else n._constructor.apply(r,t);return r},construct:function(){var e=arguments;if(e.length!=2)throw"missing arguments";var t=e[0],n=e[1],r=this.pdefsp(t);if(!r)throw"clazz "+t+" does not exist";var i=new r._class,s=r._constructors;if(s)for(var o=0;o<s.length;o++)s[o].apply(i,instargs);else r._constructor.apply(i,instargs);return i},builder:function(){var e=arguments;if(e.length==0)throw"missing arguments";var t=e[0],n=this.pdefsp(t);if(!n)throw"clazz "+t+" does not exist";return n._builder?n._builder:(n._builder=function(){var e=arguments,t=new n._class,r=n._constructors;if(r)for(var i=0;i<r.length;i++)r[i].apply(t,e);else n._constructor.apply(t,e);return t},n._builder)},builderFromPdefsp:function(){var e=arguments;if(e.length==0)throw"missing arguments";var t=e[0];if(!t)throw"clazz does not exist";return t._builder?t._builder:(t._builder=function(){var e=arguments,n=new t._class,r=t._constructors;if(r)for(var i=0;i<r.length;i++)r[i].apply(n,e);else t._constructor.apply(n,e);return n},t._builder)},global:function(){if(arguments.length==0)return this.globals;var e=arguments[0];return arguments.length==2&&(this.globals[e]=arguments[1]),this.globals[e]}};var d=new h,v=d,m=function(e){this.manager=null;for(p in e)this[p]=e[p]};m.prototype={setState:function(e){return this.state=e,this.manager.postChange(this.bundle,this.instance,this.state),this.state},getState:function(){return this.state}};var g=function(e,t,n){this.config=e,this.callback=t,this.fired=!1,this.info=n};g.prototype={execute:function(e,t,n,r){var i=this;if(i.fired)return;for(p in i.config["Import-Bundle"]){var s=e.stateForBundleSources[p];if(!s||s.state!=1){e.log("trigger not fired due "+p+" for "+r||this.info);return}}i.fired=!0,e.log("posting trigger");var o=this.callback;window.setTimeout(function(){o(e)},0)}},v.define("Oskari.BundleManager",function(){this.serial=0,this.impls={},this.sources={},this.instances={},this.bundles={},this.stateForBundleDefinitions={},this.stateForBundleSources={},this.stateForBundles={},this.stateForBundleInstances={},this.triggers=[],this.loaderStateListeners=[]},{purge:function(){for(var e in this.sources)delete this.sources[e];for(var e in this.stateForBundleDefinitions)delete this.stateForBundleDefinitions[e].loader;for(var e in this.stateForBundleSources)delete this.stateForBundleSources[e].loader},notifyLoaderStateChanged:function(e,t){if(this.loaderStateListeners.length==0)return;for(var n=0;n<this.loaderStateListeners.length;n++){var r=this.loaderStateListeners[n];r(e,t)}},registerLoaderStateListener:function(e){this.loaderStateListeners.push(e)},alert:function(e){s(e)},log:function(e){s(e)},self:function(){return this},install:function(e,t,n,r){var i=this,s=e,o=i.stateForBundleDefinitions[s];o?(o.state=1,i.log("SETTING STATE FOR BUNDLEDEF "+s+" existing state to "+o.state)):(o={state:1},i.stateForBundleDefinitions[s]=o,i.log("SETTING STATE FOR BUNDLEDEF "+s+" NEW state to "+o.state)),o.metadata=r,i.impls[s]=t,i.sources[s]=n;var u=i.stateForBundleSources[s];u&&(u.state==-1?(i.log("triggering loadBundleSources for "+s+" at loadBundleDefinition"),window.setTimeout(function(){i.loadBundleSources(s)},0)):i.log("source state for "+s+" at loadBundleDefinition is "+u.state)),i.postChange(null,null,"bundle_definition_loaded")},installBundleClass:function(e,t){var n=v.metadata(t),r=v.builder(t),i=n.meta.source,s=n.meta.bundle;this.install(e,r,i,s)},installBundlePdefsp:function(e,t){var n=v.builderFromPdefsp(t),r=t._metadata,i={};this.install(e,n,i,r)},impl:function(e){return this.impls[e]},postChange:function(e,t,n){var r=this;r.update(e,t,n);for(bid in r.bundles){var s=r.bundles[bid];s.update(r,e,t,n)}for(i in r.instances){var s=r.instances[i];if(!s)continue;s.update(r,e,t,n)}},createBundle:function(e,t){var n=e,r=this,i=r.stateForBundleDefinitions[n];if(!i)throw"INVALID_STATE: for createBundle / definition not loaded "+e+"/"+t;var s=this.impls[e];if(!s){alert("this.impls["+e+"] is null!");return}var o=s(i);return this.bundles[t]=o,this.stateForBundles[t]={state:!0,bundlImpl:n},this.postChange(o,null,"bundle_created"),o},update:function(e,t,n){var r=this;r.log("update called with info "+n);for(var i=0;i<r.triggers.length;i++){var s=r.triggers[i];s.execute(r)}},bundle:function(e){return this.bundles[e]},destroyBundle:function(e){},uninstall:function(e){var t=this.impls[e];return t},createInstance:function(e){var t=this;if(!t.stateForBundles[e]||!t.stateForBundles[e].state)throw"INVALID_STATE: for createInstance / definition not loaded "+e;var n=""+ ++this.serial,r=this.bundles[e],i=r.create();return i.mediator=new m({bundleId:e,instanceid:n,state:"initial",bundle:r,instance:i,manager:this,clazz:v,requestMediator:{}}),this.instances[n]=i,this.stateForBundleInstances[n]={state:!0,bundleid:e},this.postChange(r,i,"instance_created"),i},instance:function(e){return this.instances[e]},destroyInstance:function(e){var t=this.instances[e],n=t.mediator;return n.bundle=null,n.manager=null,n.clazz=null,t.mediator=null,this.instances[e]=null,t=null,t},on:function(e,t,n){this.triggers.push(new g(e,t,n))}}),v.define("Oskari.BundleFacade",function(e){this.manager=e,this.bundles={},this.bundleInstances={},this.appSetup=null,this.bundlePath="",this.appConfig={}},{getBundleInstanceByName:function(e){var t=this;return t.bundleInstances[e]},getBundleInstanceConfigurationByName:function(e){var t=this;return t.appConfig[e]},setConfiguration:function(e){this.appConfig=e},getConfiguration:function(){return this.appConfig}});var y=v.create("Oskari.BundleManager");y.clazz=v;var b=v.create("Oskari.BundleFacade",y),w=v.global;v.define("Oskari.DomManager",function(e){this.$=e},{getEl:function(e){return this.$(e)},getElForPart:function(e){throw"N/A"},setElForPart:function(e,t){throw"N/A"},setElParts:function(e){throw"N/A"},getElParts:function(){throw"N/A"},pushLayout:function(e){throw"N/A"},popLayout:function(e){throw"N/A"},getLayout:function(){throw"N/A"}});var E=v.create("Oskari.DomManager"),S=0,x=0,T=0;v.define("Oskari.ModuleSpec",function(e,t){this.cs=v,this.clazzInfo=e,this.clazzName=t},{slicer:Array.prototype.slice,category:function(e,t){var n=v.category(this.clazzName,t||["__",++x].join("_"),e);return this.clazzInfo=n,this},methods:function(e,t){var n=v.category(this.clazzName,t||["__",++x].join("_"),e);return this.clazzInfo=n,this},extend:function(e){var t=v.extend(this.clazzName,e.length?e:[e]);return this.clazzInfo=t,this},create:function(){return v.createWithPdefsp(this.clazzInfo,arguments)},name:function(){return this.clazzName},metadata:function(){return v.metadata(this.clazzName)},events:function(e){var t=this;return t.category({eventHandlers:e,onEvent:function(e){var t=this.eventHandlers[e.getName()];if(!t)return;return t.apply(this,[e])}},"___events"),t},requests:function(e){var t=this;return t.category({requestHandlers:e,onRequest:function(e){var t=this.requestHandlers[e.getName()];if(!t)return;return t.apply(this,[e])}},"___requests"),t},builder:function(){return v.builderFromPdefsp(this.clazzInfo)}});var N={VERSION:"2.0.0",bundle_manager:y,bundle_facade:b,bundle_locale:u,app:b,clazz:v,$:function(){return w.apply(v,arguments)},run:function(e){e()},setLoaderMode:function(e){f=e},getLoaderMode:function(){return f},setDebugMode:function(e){t=e},setSupportBundleAsync:function(e){a=e},getSupportBundleAsync:function(){return a},setBundleBasePath:function(e){basePathForBundles=e},getBundleBasePath:function(){return basePathForBundles},setPreloaded:function(e){l=e},getPreloaded:function(){return l},registerLocalization:function(e){if(!e.length)return u.setLocalization(e.lang,e.key,e.value);for(var t=0;t<e.length;t++){var n=e[t];u.setLocalization(n.lang,n.key,n.value)}},getLocalization:function(e){return u.getLocalization(e)},getLang:function(){return u.getLang()},setLang:function(e){return u.setLang(e)},purge:function(){y.purge(),v.purge("Oskari")},getDomManager:function(){return E},setDomManager:function(e){E=e},getSandbox:function(e){return w.apply(v,[e||"sandbox"])},setSandbox:function(e,t){return w.apply(v,[e||"sandbox",t])},registerMimeTypeToPlugin:function(e,t){blMimeTypeToPlugin[e]=t},cls:function(e,t,n,r){var i=undefined;return e==undefined?e=["Oskari","_",++S].join("."):i=v.lookup(e),i&&i._constructor&&!t||(i=v.define(e,t||function(){},n,r||{})),v.create("Oskari.ModuleSpec",i,e)},sandbox:function(e){var t={sandbox:w.apply(v,[e||"sandbox"])};return t.on=function(e){var t=this;if(e.eventHandlers)for(p in e.eventHandlers)t.sandbox.registerForEventByName(e,p);if(e.requestHandlers)for(r in e.requestHandlers)t.sandbox.addRequestHandler(r,reqHandlers[r])},t.off=function(e){if(e.eventHandlers)for(p in e.eventHandlers)me.sandbox.unregisterFromEventByName(e,p);if(e.requestHandlers)for(r in e.requestHandlers)me.sandbox.removeRequestHandler(r,reqHandlers[r])},t.slicer=Array.prototype.slice,t.notify=function(e){var t=this,n=t.sandbox,r=t.sandbox.getEventBuilder(e),i=t.slicer.apply(arguments,[1]),s=eventBuilder.apply(eventBuilder,i);return n.notifyAll(s)},t},loc:function(){return N.registerLocalization.apply(N,arguments)},setConfiguration:function(e){return b.setConfiguration(e)},getConfiguration:function(){return b.getConfiguration()}};N.eventCls=function(e,t,n){var r=["Oskari","event","registry",e].join("."),i=N.cls(r,t,n,{protocol:["Oskari.mapframework.event.Event"]});return i.category({getName:function(){return e}},"___event"),i.eventName=e,i},N.requestCls=function(e,t,n){var r=["Oskari","request","registry",e].join("."),i=N.cls(r,t,n,{protocol:["Oskari.mapframework.request.Request"]});return i.category({getName:function(){return e}},"___request"),i.requestName=e,i},N._baseClassFor={extension:"Oskari.userinterface.extension.EnhancedExtension",bundle:"Oskari.mapframework.bundle.extension.ExtensionBundle",tile:"Oskari.userinterface.extension.EnhancedTile",flyout:"Oskari.userinterface.extension.EnhancedFlyout",view:"Oskari.userinterface.extension.EnhancedView"},N.extensionCls=function(e){return N.cls(e).extend(this._baseClassFor.extension)},N.bundleCls=function(e,t){e||(e=["__",++T].join("_"));var n=N.cls(t,function(){},{update:function(){}},{protocol:["Oskari.bundle.Bundle",this._baseClassFor.bundle],manifest:{"Bundle-Identifier":e}});return y.installBundlePdefsp(e,n.clazzInfo),n.___bundleIdentifier=e,n.loc=function(e){return e.key=this.___bundleIdentifier,N.registerLocalization(e),n},n.start=function(e){var t=this.___bundleIdentifier;if(!b.bundles[t]){var n=y.createBundle(t,t);b.bundles[t]=n}var r=y.createInstance(t);b.bundleInstances[t]=r;var i=b.getBundleInstanceConfigurationByName(t);if(i)for(ip in i)r[ip]=i[ip];return r.start(),r},n.stop=function(){var e=this.___bundleIdentifier,t=b.bundleInstances[e];return t.stop()},n},N.flyoutCls=function(e){return N.cls(e).extend(this._baseClassFor.flyout)},N.tileCls=function(e){return N.cls(e).extend(this._baseClassFor.tile)},N.viewCls=function(e){return N.cls(e).extend(this._baseClassFor.view)},w.apply(v,["Oskari",N]),e.Oskari=N,define("bundles/oskari/oskari",["exports"],function(e){return e.Oskari=N,N})})();
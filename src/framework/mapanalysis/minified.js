Oskari.clazz.define("Oskari.mapframework.bundle.mapanalysis.plugin.AnalysisLayerPlugin",function(e){this.mapModule=null,this.pluginName=null,this.wfsLayerPlugin=null,this._sandbox=null,this._map=null,this._supportedFormats={},this.config=e,this.ajaxUrl=null,e&&e.ajaxUrl&&(this.ajaxUrl=e.ajaxUrl)},{__name:"AnalysisLayerPlugin",_layerType:"ANALYSIS",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this.pluginName=e.getName()+this.__name},hasUI:function(){return!1},register:function(){this.getMapModule().setLayerPlugin("analysislayer",this)},unregister:function(){this.getMapModule().setLayerPlugin("analysislayer",null)},init:function(e){var t=(this.config?this.config.sandbox:null)||"sandbox",n=Oskari.getSandbox(t),r=n.getService("Oskari.mapframework.service.MapLayerService");if(r){r.registerLayerModel("analysislayer","Oskari.mapframework.bundle.mapanalysis.domain.AnalysisLayer");var i=Oskari.clazz.create("Oskari.mapframework.bundle.mapanalysis.domain.AnalysisLayerModelBuilder",n);r.registerLayerModelBuilder("analysislayer",i)}this.wfsLayerPlugin=n.findRegisteredModuleInstance("MainMapModuleWfsLayerPlugin")},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);var t;for(t in this.eventHandlers)this.eventHandlers.hasOwnProperty(t)&&e.registerForEventByName(this,t);this.ajaxUrl||(this.ajaxUrl=e.getAjaxUrl()+"action_route=GetAnalysis?")},stopPlugin:function(e){var t;for(t in this.eventHandlers)this.eventHandlers.hasOwnProperty(t)&&e.unregisterFromEventByName(this,t);e.unregister(this),this._map=null,this._sandbox=null},start:function(e){},stop:function(e){},eventHandlers:{AfterMapMoveEvent:function(e){},WFSFeaturesSelectedEvent:function(e){},MapClickedEvent:function(e){},GetInfoResultEvent:function(e){},AfterChangeMapLayerStyleEvent:function(e){},MapLayerVisibilityChangedEvent:function(e){this._mapLayerVisibilityChangeEvent(e)},MapSizeChangedEvent:function(e){},WFSSetFilter:function(e){},AfterMapLayerAddEvent:function(e){this._afterMapLayerAddEvent(e)},AfterMapLayerRemoveEvent:function(e){this._afterMapLayerRemoveEvent(e)},AfterChangeMapLayerOpacityEvent:function(e){this._afterChangeMapLayerOpacityEvent(e)},"MapAnalysis.AnalysisVisualizationChangeEvent":function(e){this._afterAnalysisVisualizationChangeEvent(e)}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},preselectLayers:function(e){var t=this._sandbox,n,r,i;for(n=0;n<e.length;n++){r=e[n],i=r.getId();if(!r.isLayerOfType(this._layerType))continue;t.printDebug("preselecting "+i),this._addMapLayerToMap(r,!0,r.isBaseLayer())}},_afterMapLayerAddEvent:function(e){this._addMapLayerToMap(e.getMapLayer(),e.getKeepLayersOrder(),e.isBasemap())},_addMapLayerToMap:function(e,t,n){if(!e.isLayerOfType(this._layerType))return;var r=this,i=this._map.getLayersByName("Markers"),s;if(i)for(s=0;s<i.length;s++)i[s]&&this._map.removeLayer(i[s],!1);var o="layer_"+e.getId(),u=e.getWpsUrl()+"wpsLayerId="+e.getWpsLayerId(),a=this.getMapModule().calculateLayerScales(e.getMaxScale(),e.getMinScale()),f=new OpenLayers.Layer.WMS(o,u,{layers:e.getWpsName(),transparent:!0,format:"image/png"},{scales:a,isBaseLayer:!1,displayInLayerSwitcher:!1,visibility:!0,singleTile:!0,buffer:0});f.opacity=e.getOpacity()/100,this._map.addLayer(f),this._sandbox.printDebug("#!#! CREATED OPENLAYER.LAYER.WMS for AnalysisLayer "+e.getId()),t?this._map.setLayerIndex(f,this._map.layers.length):this._map.setLayerIndex(f,0);if(i)for(s=0;s<i.length;s++)i[s]&&this._map.addLayer(i[s])},_afterMapLayerRemoveEvent:function(e){var t=e.getMapLayer();if(!t.isLayerOfType(this._layerType))return;this._removeMapLayerFromMap(t)},_removeMapLayerFromMap:function(e){if(!e.isLayerOfType(this._layerType))return;var t=this.getOLMapLayers(e);t[0].destroy()},getOLMapLayers:function(e){return e.isLayerOfType(this._layerType)?this._map.getLayersByName("layer_"+e.getId()):null},_afterChangeMapLayerOpacityEvent:function(e){var t=e.getMapLayer();if(!t.isLayerOfType(this._layerType))return;this._sandbox.printDebug("Setting Layer Opacity for "+t.getId()+" to "+t.getOpacity());var n=this.getOLMapLayers(t);n&&n.length>0&&n[0]!==null&&n[0]!==undefined&&n[0].setOpacity(t.getOpacity()/100)},_afterAnalysisVisualizationChangeEvent:function(e){var t=e.getLayer(),n=e.getParams(),r=this.getOLMapLayers(t)},_mapLayerVisibilityChangeEvent:function(e){var t=e.getMapLayer();if(!t.isLayerOfType(this._layerType))return;var n=this.getOLMapLayers(t);n&&n.length>0&&n[0]!==null&&n[0]!==undefined&&n[0].setVisibility(t.isVisible())}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),define("bundles/framework/bundle/mapanalysis/plugin/AnalysisLayerPlugin",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapanalysis.domain.AnalysisLayer",function(){this._layerType="ANALYSIS",this._metaType="ANALYSIS"},{setWpsUrl:function(e){this._wpsUrl=e},getWpsUrl:function(){return this._wpsUrl},setWpsName:function(e){this._wpsName=e},getWpsName:function(){return this._wpsName},setWpsLayerId:function(e){this._wpsLayerId=e},getWpsLayerId:function(){return this._wpsLayerId}},{extend:["Oskari.mapframework.bundle.mapwfs2.domain.WFSLayer"]}),define("bundles/framework/bundle/mapanalysis/domain/AnalysisLayer",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapanalysis.domain.AnalysisLayerModelBuilder",function(e){this.localization=Oskari.getLocalization("MapAnalysis"),this.sandbox=e,this.wfsBuilder=Oskari.clazz.create("Oskari.mapframework.bundle.mapwfs2.domain.WfsLayerModelBuilder",e)},{parseLayerData:function(e,t,n){var r=this,i=r.localization.layer;this.wfsBuilder.parseLayerData(e,t,n),t.fields&&e.setFields(t.fields),t.locales&&e.setLocales(t.locales),t.name&&e.setName(t.name),t.wpsName&&e.setWpsName(t.wpsName),t.wpsUrl&&e.setWpsUrl(t.wpsUrl),t.wpsLayerId&&e.setWpsLayerId(t.wpsLayerId),i.organization&&e.setOrganizationName(i.organization),i.inspire&&e.setInspireName(i.inspire)}}),define("bundles/framework/bundle/mapanalysis/domain/AnalysisLayerModelBuilder",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapanalysis.event.AnalysisVisualizationChangeEvent",function(e,t){this._layer=e,this._params=t},{getName:function(){return"MapAnalysis.AnalysisVisualizationChangeEvent"},getLayer:function(){return this._layer},getParams:function(){return this._params}},{protocol:["Oskari.mapframework.event.Event"]}),define("bundles/framework/bundle/mapanalysis/event/AnalysisVisualizationChangeEvent",function(){}),Oskari.registerLocalization({lang:"fi",key:"MapAnalysis",value:{title:"MapAnalysis",desc:"","object-data":"Kohdetiedot",layer:{organization:"Omat analyysit",inspire:"Omat analyysit"}}}),define("bundles/framework/bundle/mapanalysis/locale/fi",function(){}),Oskari.registerLocalization({lang:"sv",key:"MapAnalysis",value:{title:"MapAnalysis",desc:"","object-data":"Objektuppgifter",layer:{organization:"Mina analyser",inspire:"Mina analyser"}}}),define("bundles/framework/bundle/mapanalysis/locale/sv",function(){}),Oskari.registerLocalization({lang:"en",key:"MapAnalysis",value:{title:"MapAnalysis",desc:"","object-data":"Object data",layer:{organization:"User's analysis",inspire:"User's analysis"}}}),define("bundles/framework/bundle/mapanalysis/locale/en",function(){}),define("src/framework/mapanalysis/module",["oskari","jquery","bundles/framework/bundle/mapanalysis/plugin/AnalysisLayerPlugin","bundles/framework/bundle/mapanalysis/domain/AnalysisLayer","bundles/framework/bundle/mapanalysis/domain/AnalysisLayerModelBuilder","bundles/framework/bundle/mapanalysis/event/AnalysisVisualizationChangeEvent","bundles/framework/bundle/mapanalysis/locale/fi","bundles/framework/bundle/mapanalysis/locale/sv","bundles/framework/bundle/mapanalysis/locale/en"],function(e,t){return e.bundleCls("mapanalysis").category({create:function(){return null},update:function(e,t,n,r){e.alert("RECEIVED update notification "+r)}})});
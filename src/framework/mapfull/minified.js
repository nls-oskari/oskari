Oskari.clazz.define("Oskari.mapframework.bundle.mapfull.MapFullBundleInstance",function(){this.map=null,this.core=null,this.sandbox=null,this.mapmodule=null,this.state=undefined,this.mapDivId="mapdiv",this.contentMapDivId="contentMap"},{getMapModule:function(){return this.mapmodule},getSandbox:function(){return this.sandbox},_createUi:function(){var e=this,t=Oskari.clazz.create("Oskari.mapframework.ui.module.common.MapModule","Main",e.conf.imageLocation,e.conf.mapOptions);e.mapmodule=t;var n=e.sandbox.register(t);if(e.conf.size)jQuery("#"+e.mapDivId).width(e.conf.size.width),jQuery("#"+e.mapDivId).height(e.conf.size.height);else{var r=function(){if(e.resizeEnabled===null||e.resizeEnabled===undefined||e.resizeEnabled){var n=jQuery("#"+e.contentMapDivId),r=jQuery("#"+e.mapDivId),i=jQuery(window).height();n.height(i);var s=n.find(".oskariui-menutoolbar");s.length>0&&s.is(":visible")?r.height(i-s.height()):r.height(i),t.updateSize()}},i;jQuery(window).resize(function(){clearTimeout(i),i=setTimeout(r,100)}),r();var s=window.setTimeout(r,1e3)}t.start(e.sandbox),n.render(e.mapDivId);if(e.conf.plugins){var o=this.conf.plugins,u;for(u=0;u<o.length;u++)o[u].instance=Oskari.clazz.create(o[u].id,o[u].config),t.registerPlugin(o[u].instance),t.startPlugin(o[u].instance)}e.map=n},start:function(){Proj4js.defs={"EPSG:3067":"+proj=utm +zone=35 +ellps=GRS80 +units=m +no_defs","EPSG:4326":"+title=WGS 84 +proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"};var e=this,t=e.conf;e.conf.projectionDefs&&(Proj4js.defs=e.conf.projectionDefs);var n=Oskari.getLang(),r=Oskari.clazz.create("Oskari.mapframework.core.Core");e.core=r;var i=r.getSandbox();e.sandbox=i;var s=(t?t.sandbox:null)||"sandbox";Oskari.setSandbox(s,i),jQuery.ajax({type:"POST",url:t.globalMapAjaxUrl+"action_route=GetSupportedLocales",timestamp:(new Date).getTime(),success:function(e){Oskari.setSupportedLocales(e.supportedLocales)},error:function(){}}),t&&(t.mapElement&&(e.mapDivId=t.mapElement),t.mapContainer&&(e.contentMapDivId=t.mapContainer)),i.setUser(t.user),i.setAjaxUrl(t.globalMapAjaxUrl);var o=e._createServices(t),u=[];u.push(Oskari.clazz.create("Oskari.mapframework.enhancement.mapfull.StartMapWithLinkEnhancement")),r.init(o,u),e._createUi();var a=i.getService("Oskari.mapframework.service.MapLayerService"),f=t.layers,l,c;if(f)for(l=0;l<f.length;l++)c=a.createMapLayer(f[l]),a.addLayer(c,!0);i.registerAsStateful(e.mediator.bundleId,this);var h=!1;if(e.mapmodule.isPluginActivated("GeoLocationPlugin")){var p=e.mapmodule.getPluginInstance("GeoLocationPlugin");h=p.hasSetLocation()}e.setState(e.state,h),e.mapResizeEnabledRequestHandler=Oskari.clazz.create("Oskari.mapframework.bundle.mapfull.request.MapResizeEnabledRequestHandler",e),e.mapWindowFullScreenRequestHandler=Oskari.clazz.create("Oskari.mapframework.bundle.mapfull.request.MapWindowFullScreenRequestHandler",e),i.addRequestHandler("MapFull.MapResizeEnabledRequest",e.mapResizeEnabledRequestHandler),i.addRequestHandler("MapFull.MapWindowFullScreenRequest",e.mapWindowFullScreenRequestHandler)},_teardownState:function(e){var t=this.sandbox.findAllSelectedMapLayers(),n=this.sandbox.getRequestBuilder("RemoveMapLayerRequest"),r;for(r=0;r<t.length;r++)this.sandbox.request(e.getName(),n(t[r].getId()))},_createServices:function(e){var t=this,n=[],r=Oskari.clazz.create("Oskari.mapframework.service.MapLayerService",e.globalMapAjaxUrl+"action_route=GetMapLayers&lang="+Oskari.getLang(),t.core.getSandbox());return n.push(r),e.disableDevelopmentMode=="true"&&t.core.disableDebug(),n},update:function(){},stop:function(){this.sandbox.unregisterStateful(this.mediator.bundleId),alert("Stopped!")},setState:function(e,t){var n=this,r=n.sandbox.findRegisteredModuleInstance("MainMapModule"),i,s,o,u,a,f,l;n._teardownState(r);if(e.selectedLayers){i=n.sandbox.getRequestBuilder("AddMapLayerRequest"),s=n.sandbox.getRequestBuilder("ChangeMapLayerOpacityRequest"),o=n.sandbox.getRequestBuilder("MapModulePlugin.MapLayerVisibilityRequest"),u=n.sandbox.getRequestBuilder("ChangeMapLayerStyleRequest"),a=e.selectedLayers.length;for(f=0;f<a;++f)l=e.selectedLayers[f],n.sandbox.request(r.getName(),i(l.id,!0)),n.sandbox.request(r.getName(),o(l.id,l.hidden!==!0)),l.style&&n.sandbox.request(r.getName(),u(l.id,l.style)),l.opacity&&n.sandbox.request(r.getName(),s(l.id,l.opacity))}e.east&&t!==!0&&n.sandbox.getMap().moveTo(e.east,e.north,e.zoom),n.sandbox.syncMapState(!0)},getState:function(){var e=this.sandbox.getMap(),t=this.sandbox.findAllSelectedMapLayers(),n=e.getZoom(),r=e.getX(),i=e.getY(),s,o,u,a={north:i,east:r,zoom:e.getZoom(),srs:e.getSrsName(),selectedLayers:[]};for(s=0;s<t.length;s++)o=t[s],u={id:o.getId(),opacity:o.getOpacity()},o.isVisible()||(u.hidden=!0),o.getCurrentStyle&&o.getCurrentStyle()&&o.getCurrentStyle().getName()&&o.getCurrentStyle().getName()!=="!default!"&&(u.style=o.getCurrentStyle().getName()),a.selectedLayers.push(u);return a},getStateParameters:function(){var e=this.getState(),t="zoomLevel="+e.zoom+"&coord="+e.east+"_"+e.north+"&mapLayers=",n=e.selectedLayers,r="",i=null,s=0,o=0;for(s=0,o=n.length;s<o;s++)i=n[s],i.hidden||(r!==""&&(r+=","),r+=i.id+"+"+i.opacity,i.style?r+="+"+i.style:r+="+");return t+r},toggleFullScreen:function(){jQuery("#"+this.contentMapDivId).toggleClass("oskari-map-window-fullscreen"),this.mapmodule.getMap().updateSize()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.userinterface.Stateful"]}),define("bundles/framework/bundle/mapfull/instance",function(){}),Oskari.clazz.define("Oskari.mapframework.enhancement.mapfull.StartMapWithLinkEnhancement",function(){},{enhance:function(e){function u(e){return e===!0||e==="true"}e.printDebug("Checking if map is started with link...");var t=e.getRequestParameter("coord"),n=e.getRequestParameter("zoomLevel"),r=e.getRequestParameter("mapLayers"),i=e.getRequestParameter("showMarker"),s=e.getRequestParameter("isCenterMarker"),o=e.getRequestParameter("keepLayersOrder");o===null&&(o=!0),e.getMap().setMarkerVisible(u(i)||u(s));if(t===null||n===null)return;var a;t.indexOf("_")>=0?a=t.split("_"):a=t.split("%20");var f=a[0],l=a[1];if(f===null||l===null){e.printDebug("Could not parse link location. Skipping.");return}e.printDebug("This is startup by link, moving map..."),e.getMap().moveTo(f,l,n)}},{protocol:["Oskari.mapframework.enhancement.Enhancement"]}),define("bundles/framework/bundle/mapfull/enhancement/start-map-with-link-enhancement",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapfull.request.MapResizeEnabledRequest",function(e){this._creator=null,this._resizeEnabled=e},{__name:"MapFull.MapResizeEnabledRequest",getName:function(){return this.__name},getResizeEnabled:function(){return this._resizeEnabled}},{protocol:["Oskari.mapframework.request.Request"]}),define("bundles/framework/bundle/mapfull/request/MapResizeEnabledRequest",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapfull.request.MapResizeEnabledRequestHandler",function(e){this.mapfull=e},{handleRequest:function(e,t){this.mapfull.resizeEnabled=t.getResizeEnabled()}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),define("bundles/framework/bundle/mapfull/request/MapResizeEnabledRequestHandler",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapfull.request.MapWindowFullScreenRequest",function(){this._creator=null},{__name:"MapFull.MapWindowFullScreenRequest",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.request.Request"]}),define("bundles/framework/bundle/mapfull/request/MapWindowFullScreenRequest",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapfull.request.MapWindowFullScreenRequestHandler",function(e){this.mapfull=e},{handleRequest:function(e,t){this.mapfull.toggleFullScreen()}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),define("bundles/framework/bundle/mapfull/request/MapWindowFullScreenRequestHandler",function(){}),define("normalize",["require","module"],function(e,t){function o(e,t,n){if(e.indexOf("data:")===0)return e;e=r(e);if(e.match(/^\//)||e.match(s))return e;var i=n.match(s),o=t.match(s);return o&&(!i||i[1]!=o[1]||i[2]!=o[2])?u(e,t):a(u(e,t),n)}function u(e,t){e.substr(0,2)=="./"&&(e=e.substr(2));var n=t.split("/"),r=e.split("/");n.pop();while(curPart=r.shift())curPart==".."?n.pop():n.push(curPart);return n.join("/")}function a(e,t){var n=t.split("/");n.pop(),t=n.join("/")+"/",i=0;while(t.substr(i,1)==e.substr(i,1))i++;while(t.substr(i,1)!="/")i--;t=t.substr(i+1),e=e.substr(i+1),n=t.split("/");var r=e.split("/");out="";while(n.shift())out+="../";while(curPart=r.shift())out+=curPart+"/";return out.substr(0,out.length-1)}var n=/([^:])\/+/g,r=function(e){return e.replace(n,"$1/")},s=/[^\:\/]*:\/\/([^\/])*/,f=function(e,t,n,i){t=r(t),n=r(n);var s=/@import\s*("([^"]*)"|'([^']*)')|url\s*\(\s*(\s*"([^"]*)"|'([^']*)'|[^\)]*\s*)\s*\)/ig,u,a,e;while(u=s.exec(e)){a=u[3]||u[2]||u[5]||u[6]||u[4];var f;i&&a.substr(0,1)=="/"?f=i+a:f=o(a,t,n);var l=u[5]||u[6]?1:0;e=e.substr(0,s.lastIndex-a.length-l-1)+f+e.substr(s.lastIndex-l-1),s.lastIndex=s.lastIndex+(f.length-a.length)}return e};return f.convertURIBase=o,f}),define("css",["./normalize"],function(e){function n(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1}var t=0;if(typeof window=="undefined")return{load:function(e,t,n){n()}};var r=!1,i=document.getElementsByTagName("head")[0],s=window.navigator.userAgent.match(/Trident\/([^ ;]*)|AppleWebKit\/([^ ;]*)|Opera\/([^ ;]*)|rv\:([^ ;]*)(.*?)Gecko\/([^ ;]*)|MSIE\s([^ ;]*)/),o=!1;!s||(s[1]||s[7]?(o=parseInt(s[1])<6||parseInt(s[7])<=9,s="trident"):s[2]?(o=!0,s="webkit"):s[3]||(s[4]?(o=parseInt(s[4])<18,s="gecko"):r&&alert("Engine detection failed")));var u={},a=/^\/|([^\:\/]*:)/;u.pluginBuilder="./css-builder";var f=[],l={},c=[];u.addBuffer=function(e){if(n(f,e)!=-1)return;if(n(c,e)!=-1)return;f.push(e),c.push(e)},u.setBuffer=function(t,n){var r=window.location.pathname.split("/");r.pop(),r=r.join("/")+"/";var i=require.toUrl("base_url").split("/");i.pop();var s=i.join("/")+"/";s=e.convertURIBase(s,r,"/"),s.match(a)||(s="/"+s),s.substr(s.length-1,1)!="/"&&(s+="/"),u.inject(e(t,s,r));for(var o=0;o<f.length;o++)(n&&f[o].substr(f[o].length-5,5)==".less"||!n&&f[o].substr(f[o].length-4,4)==".css")&&(function(e){l[e]=l[e]||!0,setTimeout(function(){typeof l[e]=="function"&&l[e](),delete l[e]},7)}(f[o]),f.splice(o--,1))},u.attachBuffer=function(e,t){for(var r=0;r<f.length;r++)if(f[r]==e)return l[e]=t,!0;if(l[e]===!0)return l[e]=t,!0;if(n(c,e)!=-1)return t(),!0};var h=function(e,t){setTimeout(function(){for(var n=0;n<document.styleSheets.length;n++){var r=document.styleSheets[n];if(r.href==e.href)return t()}h(e,t)},10)},p=function(e,t){setTimeout(function(){try{return e.sheet.cssRules,t()}catch(n){}p(e,t)},10)};if(s=="trident"&&o)var d=[],v=[],m=0,g=function(e,t){var n;v.push({url:e,cb:t}),n=d.shift(),!n&&m++<31&&(n=document.createElement("style"),i.appendChild(n)),n&&y(n)},y=function(e){var t=v.shift();if(!t){e.onload=w,d.push(e);return}e.onload=function(){t.cb(t.ss),y(e)};try{var n=e.styleSheet;t.ss=n.imports[n.addImport(t.url)]}catch(r){alert("Got Error:"+r)}};var b=function(e){var t=document.createElement("link");return t.type="text/css",t.rel="stylesheet",t.href=e,t},w=function(){};u.linkLoad=function(e,t){var n=setTimeout(function(){r&&alert("timeout"),t()},A*1e3-100),u=function(){clearTimeout(n),a&&(a.onload=w),setTimeout(t,7)};if(!o){var a=b(e);a.onload=u,i.appendChild(a)}else if(s=="webkit"){var a=b(e);h(a,u),i.appendChild(a)}else if(s=="gecko"){var f=document.createElement("style");f.textContent='@import "'+e+'"',p(f,u),i.appendChild(f)}else s=="trident"&&g(e,u)};var E=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],S={},x=function(e,t,n){if(S[e]){t(S[e]);return}var r,i,s;if(typeof XMLHttpRequest!="undefined")r=new XMLHttpRequest;else if(typeof ActiveXObject!="undefined")for(i=0;i<3;i+=1){s=E[i];try{r=new ActiveXObject(s)}catch(o){}if(r){E=[s];break}}r.open("GET",e,requirejs.inlineRequire?!1:!0),r.onreadystatechange=function(i){var s,o;r.readyState===4&&(s=r.status,s>399&&s<600?(o=new Error(e+" HTTP status: "+s),o.xhr=r,n(o)):(S[e]=r.responseText,t(r.responseText)))},r.send(null)},T=0,N;u.inject=function(e){T<31&&(N=document.createElement("style"),N.type="text/css",i.appendChild(N),T++),N.styleSheet?N.styleSheet.cssText+=e:N.appendChild(document.createTextNode(e))};var C=/@import\s*(url)?\s*(('([^']*)'|"([^"]*)")|\(('([^']*)'|"([^"]*)"|([^\)]*))\))\s*;?/g,k=window.location.pathname.split("/");k.pop(),k=k.join("/")+"/";var L=function(t,n,r){t.match(a)||(t="/"+e.convertURIBase(t,k,"/")),x(t,function(i){i=e(i,t,k);var s=[],o=[],u=[],a;while(a=C.exec(i)){var f=a[4]||a[5]||a[7]||a[8]||a[9];s.push(f),o.push(C.lastIndex-a[0].length),u.push(a[0].length)}var l=0;for(var c=0;c<s.length;c++)(function(e){L(s[e],function(t){i=i.substr(0,o[e])+t+i.substr(o[e]+u[e]);var r=t.length-u[e];for(var a=e+1;a<s.length;a++)o[a]+=r;l++,l==s.length&&n(i)},r)})(c);s.length==0&&n(i)},r)};u.normalize=function(e,t){return e.substr(e.length-4,4)==".css"&&(e=e.substr(0,e.length-4)),t(e)};var A,O=!1;return u.load=function(e,t,n,i,s){A=A||i.waitSeconds||7;var a=e+(s?".less":".css");if(u.attachBuffer(a,n))return;var f=t.toUrl(a);!O&&r&&(alert(o?"hacking links":"not hacking"),O=!0),s?L(f,function(e){s&&(e=s(e,function(e){u.inject(e),setTimeout(n,7)}))}):u.linkLoad(f,n)},r&&(u.inspect=function(){if(stylesheet.styleSheet)return stylesheet.styleSheet.cssText;if(stylesheet.innerHTML)return stylesheet.innerHTML}),u}),requirejs.s.contexts._.nextTick=function(e){e()},require(["css"],function(e){e.addBuffer("resources/framework/bundle/mapfull/css/style.css")}),requirejs.s.contexts._.nextTick=requirejs.nextTick,define("src/framework/mapfull/module",["oskari","jquery","bundles/framework/bundle/mapfull/instance","bundles/framework/bundle/mapfull/enhancement/start-map-with-link-enhancement","bundles/framework/bundle/mapfull/request/MapResizeEnabledRequest","bundles/framework/bundle/mapfull/request/MapResizeEnabledRequestHandler","bundles/framework/bundle/mapfull/request/MapWindowFullScreenRequest","bundles/framework/bundle/mapfull/request/MapWindowFullScreenRequestHandler","css!resources/framework/bundle/mapfull/css/style.css"],function(e,t){return e.bundleCls("mapfull").category({create:function(){return e.clazz.create("Oskari.mapframework.bundle.mapfull.MapFullBundleInstance")},update:function(e,t,n,r){}})}),requirejs.s.contexts._.nextTick=function(e){e()},require(["css"],function(e){e.setBuffer("#contentMap.oskari-map-window-fullscreen {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100%;\n  z-index: 10000;\n  margin: 0 !important; }\n")}),requirejs.s.contexts._.nextTick=requirejs.nextTick;
/*
 * Copyright (c) 2010 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/*!
* jQuery Cookie Plugin v1.2
* https://github.com/carhartl/jquery-cookie
*
* Copyright 2011, Klaus Hartl
* Dual licensed under the MIT or GPL Version 2 licenses.
* http://www.opensource.org/licenses/mit-license.php
* http://www.opensource.org/licenses/GPL-2.0
*/

/** modifications free software  (c) 2009-IV maanmittauslaitos.fi **/

/* Copyright (c) 2006-2008 MetaCarta, Inc., published under the Clear BSD
 * license.  See http://svn.openlayers.org/trunk/openlayers/license.txt for the
 * full text of the license. */

/*
/* Copyright (c) 2006-2008 MetaCarta, Inc., published under the Clear BSD
 * license.  See http://svn.openlayers.org/trunk/openlayers/license.txt for the
 * full text of the license.
 */

this.org=this.org||{},org.cometd={},org.cometd.JSON={},org.cometd.JSON.toJSON=org.cometd.JSON.fromJSON=function(e){throw"Abstract"},org.cometd.Utils={},org.cometd.Utils.isString=function(e){return e===undefined||e===null?!1:typeof e=="string"||e instanceof String},org.cometd.Utils.isArray=function(e){return e===undefined||e===null?!1:e instanceof Array},org.cometd.Utils.inArray=function(e,t){for(var n=0;n<t.length;++n)if(e===t[n])return n;return-1},org.cometd.Utils.setTimeout=function(e,t,n){return window.setTimeout(function(){try{t()}catch(n){e._debug("Exception invoking timed function",t,n)}},n)},org.cometd.Utils.clearTimeout=function(e){window.clearTimeout(e)},org.cometd.TransportRegistry=function(){var e=[],t={};this.getTransportTypes=function(){return e.slice(0)},this.findTransportTypes=function(n,r,i){var s=[];for(var o=0;o<e.length;++o){var u=e[o];t[u].accept(n,r,i)===!0&&s.push(u)}return s},this.negotiateTransport=function(n,r,i,s){for(var o=0;o<e.length;++o){var u=e[o];for(var a=0;a<n.length;++a)if(u===n[a]){var f=t[u];if(f.accept(r,i,s)===!0)return f}}return null},this.add=function(n,r,i){var s=!1;for(var o=0;o<e.length;++o)if(e[o]===n){s=!0;break}return s||(typeof i!="number"?e.push(n):e.splice(i,0,n),t[n]=r),!s},this.find=function(n){for(var r=0;r<e.length;++r)if(e[r]===n)return t[n];return null},this.remove=function(n){for(var r=0;r<e.length;++r)if(e[r]===n){e.splice(r,1);var i=t[n];return delete t[n],i}return null},this.clear=function(){e=[],t={}},this.reset=function(){for(var n=0;n<e.length;++n)t[e[n]].reset()}},org.cometd.Transport=function(){var e,t;this.registered=function(n,r){e=n,t=r},this.unregistered=function(){e=null,t=null},this._debug=function(){t._debug.apply(t,arguments)},this._mixin=function(){return t._mixin.apply(t,arguments)},this.getConfiguration=function(){return t.getConfiguration()},this.getAdvice=function(){return t.getAdvice()},this.setTimeout=function(e,n){return org.cometd.Utils.setTimeout(t,e,n)},this.clearTimeout=function(e){org.cometd.Utils.clearTimeout(e)},this.convertToMessages=function(e){if(org.cometd.Utils.isString(e))try{return org.cometd.JSON.fromJSON(e)}catch(t){throw this._debug("Could not convert to JSON the following string",'"'+e+'"'),t}if(org.cometd.Utils.isArray(e))return e;if(e===undefined||e===null)return[];if(e instanceof Object)return[e];throw"Conversion Error "+e+", typeof "+typeof e},this.accept=function(e,t,n){throw"Abstract"},this.getType=function(){return e},this.send=function(e,t){throw"Abstract"},this.reset=function(){this._debug("Transport",e,"reset")},this.abort=function(){this._debug("Transport",e,"aborted")},this.toString=function(){return this.getType()}},org.cometd.Transport.derive=function(e){function t(){}return t.prototype=e,new t},org.cometd.RequestTransport=function(){function o(e){while(s.length>0){var t=s[0],n=t[0],r=t[1];if(n.url===e.url&&n.sync===e.sync){s.shift(),e.messages=e.messages.concat(n.messages),this._debug("Coalesced",n.messages.length,"messages from request",r.id);continue}break}}function u(e,t){this.transportSend(e,t),t.expired=!1;if(!e.sync){var n=this.getConfiguration().maxNetworkDelay,r=n;t.metaConnect===!0&&(r+=this.getAdvice().timeout),this._debug("Transport",this.getType(),"waiting at most",r,"ms for the response, maxNetworkDelay",n);var i=this;t.timeout=this.setTimeout(function(){t.expired=!0,t.xhr&&t.xhr.abort();var n="Request "+t.id+" of transport "+i.getType()+" exceeded "+r+" ms max network delay";i._debug(n),i.complete(t,!1,t.metaConnect),e.onFailure(t.xhr,e.messages,"timeout",n)},r)}}function a(e){var t=++n,r={id:t,metaConnect:!1};i.length<this.getConfiguration().maxConnections-1?(i.push(r),u.call(this,e,r)):(this._debug("Transport",this.getType(),"queueing request",t,"envelope",e),s.push([e,r]))}function f(e){var t=e.id;this._debug("Transport",this.getType(),"metaConnect complete, request",t);if(r!==null&&r.id!==t)throw"Longpoll request mismatch, completing request "+t;r=null}function l(e,t){var n=org.cometd.Utils.inArray(e,i);n>=0&&i.splice(n,1);if(s.length>0){var r=s.shift(),u=r[0],f=r[1];this._debug("Transport dequeued request",f.id);if(t)this.getConfiguration().autoBatch&&o.call(this,u),a.call(this,u),this._debug("Transport completed request",e.id,u);else{var l=this;this.setTimeout(function(){l.complete(f,!1,f.metaConnect),u.onFailure(f.xhr,u.messages,"error","Previous request failed")},0)}}}function c(e){if(r!==null)throw"Concurrent metaConnect requests not allowed, request id="+r.id+" not yet completed";var t=++n;this._debug("Transport",this.getType(),"metaConnect send, request",t,"envelope",e);var i={id:t,metaConnect:!0};u.call(this,e,i),r=i}var e=new org.cometd.Transport,t=org.cometd.Transport.derive(e),n=0,r=null,i=[],s=[];return t.complete=function(e,t,n){n?f.call(this,e):l.call(this,e,t)},t.transportSend=function(e,t){throw"Abstract"},t.transportSuccess=function(e,t,n){t.expired||(this.clearTimeout(t.timeout),this.complete(t,!0,t.metaConnect),n&&n.length>0?e.onSuccess(n):e.onFailure(t.xhr,e.messages,"Empty HTTP response"))},t.transportFailure=function(e,t,n,r){t.expired||(this.clearTimeout(t.timeout),this.complete(t,!1,t.metaConnect),e.onFailure(t.xhr,e.messages,n,r))},t.send=function(e,t){t?c.call(this,e):a.call(this,e)},t.abort=function(){e.abort();for(var t=0;t<i.length;++t){var n=i[t];this._debug("Aborting request",n),n.xhr&&n.xhr.abort()}r&&(this._debug("Aborting metaConnect request",r),r.xhr&&r.xhr.abort()),this.reset()},t.reset=function(){e.reset(),r=null,i=[],s=[]},t},org.cometd.LongPollingTransport=function(){var e=new org.cometd.RequestTransport,t=org.cometd.Transport.derive(e),n=!0;return t.accept=function(e,t,r){return n||!t},t.xhrSend=function(e){throw"Abstract"},t.transportSend=function(e,t){this._debug("Transport",this.getType(),"sending request",t.id,"envelope",e);var r=this;try{var i=!0;t.xhr=this.xhrSend({transport:this,url:e.url,sync:e.sync,headers:this.getConfiguration().requestHeaders,body:org.cometd.JSON.toJSON(e.messages),onSuccess:function(i){r._debug("Transport",r.getType(),"received response",i);var s=!1;try{var o=r.convertToMessages(i);o.length===0?(n=!1,r.transportFailure(e,t,"no response",null)):(s=!0,r.transportSuccess(e,t,o))}catch(u){r._debug(u),s||(n=!1,r.transportFailure(e,t,"bad response",u))}},onError:function(s,o){n=!1,i?r.setTimeout(function(){r.transportFailure(e,t,s,o)},0):r.transportFailure(e,t,s,o)}}),i=!1}catch(s){n=!1,this.setTimeout(function(){r.transportFailure(e,t,"error",s)},0)}},t.reset=function(){e.reset(),n=!0},t},org.cometd.CallbackPollingTransport=function(){var e=new org.cometd.RequestTransport,t=org.cometd.Transport.derive(e),n=2e3;return t.accept=function(e,t,n){return!0},t.jsonpSend=function(e){throw"Abstract"},t.transportSend=function(e,t){var r=this,i=0,s=e.messages.length,o=[];while(s>0){var u=org.cometd.JSON.toJSON(e.messages.slice(i,i+s)),a=e.url.length+encodeURI(u).length;if(a>n){if(s===1){var f="Bayeux message too big ("+a+" bytes, max is "+n+") "+"for transport "+this.getType();this.setTimeout(function(){r.transportFailure(e,t,"error",f)},0);return}--s;continue}o.push(s),i+=s,s=e.messages.length-i}var l=e;if(o.length>1){var c=0,h=o[0];this._debug("Transport",this.getType(),"split",e.messages.length,"messages into",o.join(" + ")),l=this._mixin(!1,{},e),l.messages=e.messages.slice(c,h),l.onSuccess=e.onSuccess,l.onFailure=e.onFailure;for(var p=1;p<o.length;++p){var d=this._mixin(!1,{},e);c=h,h+=o[p],d.messages=e.messages.slice(c,h),d.onSuccess=e.onSuccess,d.onFailure=e.onFailure,this.send(d,t.metaConnect)}}this._debug("Transport",this.getType(),"sending request",t.id,"envelope",l);try{var v=!0;this.jsonpSend({transport:this,url:l.url,sync:l.sync,headers:this.getConfiguration().requestHeaders,body:org.cometd.JSON.toJSON(l.messages),onSuccess:function(e){var n=!1;try{var i=r.convertToMessages(e);i.length===0?r.transportFailure(l,t,"no response"):(n=!0,r.transportSuccess(l,t,i))}catch(s){r._debug(s),n||r.transportFailure(l,t,"bad response",s)}},onError:function(e,n){v?r.setTimeout(function(){r.transportFailure(l,t,e,n)},0):r.transportFailure(l,t,e,n)}}),v=!1}catch(m){this.setTimeout(function(){r.transportFailure(l,t,"error",m)},0)}},t},org.cometd.WebSocketTransport=function(){function c(){var e=n.getURL().replace(/^http/,"ws");this._debug("Transport",this.getType(),"connecting to URL",e);var t=this,r=null,i=n.getConfiguration().connectTimeout;i>0&&(r=this.setTimeout(function(){r=null,a||(t._debug("Transport",t.getType(),"timed out while connecting to URL",e,":",i,"ms"),t.onClose(1002,"Connect Timeout"))},i));var s=new org.cometd.WebSocket(e),o=function(){t._debug("WebSocket opened",s),r&&(t.clearTimeout(r),r=null);if(s!==u){t._debug("Ignoring open event, WebSocket",u);return}t.onOpen()},f=function(e){var n=e?e.code:1e3,i=e?e.reason:undefined;t._debug("WebSocket closed",n,"/",i,s),r&&(t.clearTimeout(r),r=null);if(s!==u){t._debug("Ignoring close event, WebSocket",u);return}t.onClose(n,i)},l=function(e){t._debug("WebSocket message",e,s);if(s!==u){t._debug("Ignoring message event, WebSocket",u);return}t.onMessage(e)};s.onopen=o,s.onclose=f,s.onerror=function(){f({code:1002})},s.onmessage=l,u=s,this._debug("Transport",this.getType(),"configured callbacks on",s)}function h(e,t){var n=org.cometd.JSON.toJSON(e.messages);u.send(n),this._debug("Transport",this.getType(),"sent",e,"metaConnect =",t);var r=this.getConfiguration().maxNetworkDelay,i=r;t&&(i+=this.getAdvice().timeout,f=!0);var s=[];for(var a=0;a<e.messages.length;++a){var l=e.messages[a];if(l.id){s.push(l.id);var c=this,h=u;o[l.id]=this.setTimeout(function(){h&&h.close(1e3,"Timeout")},i)}}this._debug("Transport",this.getType(),"waiting at most",i,"ms for messages",s,"maxNetworkDelay",r,", timeouts:",o)}function p(e,t){try{u===null?c.call(this):a&&h.call(this,e,t)}catch(n){var r=u;this.setTimeout(function(){e.onFailure(r,e.messages,"error",n)},0)}}var e=new org.cometd.Transport,t=org.cometd.Transport.derive(e),n,r=!0,i=!1,s={},o={},u=null,a=!1,f=!1,l;return t.onOpen=function(){this._debug("Transport",this.getType(),"opened",u),a=!0,i=!0,this._debug("Sending pending messages",s);for(var e in s){var t=s[e],n=t[0],r=t[1];l=n.onSuccess,h.call(this,n,r)}},t.onMessage=function(e){this._debug("Transport",this.getType(),"received websocket message",e,u);var t=!1,n=this.convertToMessages(e.data),r=[];for(var i=0;i<n.length;++i){var a=n[i];if(/^\/meta\//.test(a.channel)||a.data===undefined)if(a.id){r.push(a.id);var c=o[a.id];c&&(this.clearTimeout(c),delete o[a.id],this._debug("Transport",this.getType(),"removed timeout for message",a.id,", timeouts",o))}"/meta/connect"===a.channel&&(f=!1),"/meta/disconnect"===a.channel&&!f&&(t=!0)}var h=!1;for(var p=0;p<r.length;++p){var d=r[p];for(var v in s){var m=v.split(","),g=org.cometd.Utils.inArray(d,m);if(g>=0){h=!0,m.splice(g,1);var y=s[v][0],b=s[v][1];delete s[v],m.length>0&&(s[m.join(",")]=[y,b]);break}}}h&&this._debug("Transport",this.getType(),"removed envelope, envelopes",s),l.call(this,n),t&&u.close(1e3,"Disconnect")},t.onClose=function(e,t){this._debug("Transport",this.getType(),"closed",e,t,u),r=i;for(var n in o)this.clearTimeout(o[n]);o={};for(var l in s){var c=s[l][0],h=s[l][1];h&&(f=!1),c.onFailure(u,c.messages,"closed "+e+"/"+t)}s={},u!==null&&a&&u.close(1e3,"Close"),a=!1,u=null},t.registered=function(t,r){e.registered(t,r),n=r},t.accept=function(e,t,i){return r&&!!org.cometd.WebSocket&&n.websocketEnabled!==!1},t.send=function(e,t){this._debug("Transport",this.getType(),"sending",e,"metaConnect =",t);var n=[];for(var r=0;r<e.messages.length;++r){var i=e.messages[r];i.id&&n.push(i.id)}s[n.join(",")]=[e,t],this._debug("Transport",this.getType(),"stored envelope, envelopes",s),p.call(this,e,t)},t.abort=function(){e.abort();if(u!==null)try{u.close(1001)}catch(t){this._debug(t)}this.reset()},t.reset=function(){e.reset(),u!==null&&a&&u.close(1e3,"Reset"),r=!0,i=!1,o={},s={},u=null,a=!1,l=null},t},org.cometd.Cometd=function(e){function S(e){return org.cometd.Utils.isString(e)}function x(e){return e===undefined||e===null?!1:typeof e=="function"}function T(e,t){if(window.console){var n=window.console[e];x(n)&&n.apply(window.console,t)}}function N(e){t._debug("Configuring cometd object with",e),S(e)&&(e={url:e}),e||(e={}),E=t._mixin(!1,E,e);if(!E.url)throw"Missing required configuration parameter 'url' specifying the Bayeux server URL";var n=/(^https?:\/\/)?(((\[[^\]]+\])|([^:\/\?#]+))(:(\d+))?)?([^\?#]*)(.*)?/.exec(E.url),i=n[2],s=n[8],o=n[9];r=t._isCrossDomain(i);if(E.appendMessageTypeToURL)if(o!==undefined&&o.length>0)t._info("Appending message type to URI "+s+o+" is not supported, disabling 'appendMessageTypeToURL' configuration"),E.appendMessageTypeToURL=!1;else{var u=s.split("/"),a=u.length-1;s.match(/\/$/)&&(a-=1),u[a].indexOf(".")>=0&&(t._info("Appending message type to URI "+s+" is not supported, disabling 'appendMessageTypeToURL' configuration"),E.appendMessageTypeToURL=!1)}}function C(){for(var e in h){var n=h[e];for(var r=0;r<n.length;++r){var i=n[r];i&&!i.listener&&(delete n[r],t._debug("Removed subscription",i,"for channel",e))}}}function k(e){o!==e&&(t._debug("Status",o,"->",e),o=e)}function L(){return o==="disconnecting"||o==="disconnected"}function A(){return++u}function O(e,n,r,i,s){try{return n.call(e,i)}catch(o){t._debug("Exception during execution of extension",r,o);var u=t.onExtensionException;if(x(u)){t._debug("Invoking extension exception callback",r,o);try{u.call(t,o,r,s,i)}catch(a){t._info("Exception during execution of exception callback in extension",r,a)}}return i}}function M(e){for(var t=0;t<v.length;++t){if(e===undefined||e===null)break;var n=E.reverseIncomingExtensions?v.length-1-t:t,r=v[n],i=r.extension.incoming;if(x(i)){var s=O(r.extension,i,r.name,e,!1);e=s===undefined?e:s}}return e}function _(e){for(var t=0;t<v.length;++t){if(e===undefined||e===null)break;var n=v[t],r=n.extension.outgoing;if(x(r)){var i=O(n.extension,r,n.name,e,!0);e=i===undefined?e:i}}return e}function D(e,n){var r=h[e];if(r&&r.length>0)for(var i=0;i<r.length;++i){var s=r[i];if(s)try{s.callback.call(s.scope,n)}catch(o){t._debug("Exception during notification",s,n,o);var u=t.onListenerException;if(x(u)){t._debug("Invoking listener exception callback",s,o);try{u.call(t,o,s.handle,s.listener,n)}catch(a){t._info("Exception during execution of listener callback",s,a)}}}}}function P(e,t){D(e,t);var n=e.split("/"),r=n.length-1;for(var i=r;i>0;--i){var s=n.slice(0,i).join("/")+"/*";i===r&&D(s,t),s+="*",D(s,t)}}function H(){d!==null&&org.cometd.Utils.clearTimeout(d),d=null}function B(e){H();var n=m.interval+p;t._debug("Function scheduled in",n,"ms, interval =",m.interval,"backoff =",p,e),d=org.cometd.Utils.setTimeout(t,e,n)}function I(e,n,r,i){for(var o=0;o<n.length;++o){var u=n[o];u.id=""+A(),a&&(u.clientId=a);var f=undefined;x(u._callback)&&(f=u._callback,delete u._callback),u=_(u),u!==undefined&&u!==null?(n[o]=u,f&&(y[u.id]=f)):n.splice(o--,1)}if(n.length===0)return;var l=E.url;E.appendMessageTypeToURL&&(l.match(/\/$/)||(l+="/"),i&&(l+=i));var c={url:l,sync:e,messages:n,onSuccess:function(e){try{j.call(t,e)}catch(n){t._debug("Exception during handling of messages",n)}},onFailure:function(e,n,r,i){try{F.call(t,e,n,r,i)}catch(s){t._debug("Exception during handling of failure",s)}}};t._debug("Send",c),s.send(c,r)}function q(e){f>0||c===!0?l.push(e):I(!1,[e],!1)}function R(){p=0}function U(){p<E.maxBackoff&&(p+=E.backoffIncrement)}function z(){++f}function W(){var e=l;l=[],e.length>0&&I(!1,e,!1)}function X(){--f;if(f<0)throw"Calls to startBatch() and endBatch() are not paired";f===0&&!L()&&!c&&W()}function V(){if(!L()){var e={channel:"/meta/connect",connectionType:s.getType()};w||(e.advice={timeout:0}),k("connecting"),t._debug("Connect sent",e),I(!1,[e],!0,"connect"),k("connected")}}function $(){k("connecting"),B(function(){V()})}function J(e){e&&(m=t._mixin(!1,{},E.advice,e),t._debug("New advice",m))}function K(e){H(),e&&s.abort(),a=null,k("disconnected"),f=0,R(),l.length>0&&(F.call(t,undefined,l,"error","Disconnected"),l=[])}function Q(e){a=null,C(),L()?(i.reset(),J(E.advice)):J(t._mixin(!1,m,{reconnect:"retry"})),f=0,c=!0,g=e;var n="1.0",o=i.findTransportTypes(n,r,E.url),u={version:n,minimumVersion:"0.9",channel:"/meta/handshake",supportedConnectionTypes:o,advice:{timeout:m.timeout,interval:m.interval}},l=t._mixin(!1,{},g,u);s=i.negotiateTransport(o,n,r,E.url),t._debug("Initial transport is",s.getType()),k("handshaking"),t._debug("Handshake sent",l),I(!1,[l],!1,"handshake")}function G(){k("handshaking"),c=!0,B(function(){Q(g)})}function Y(e){P("/meta/handshake",e),P("/meta/unsuccessful",e);var t=!L()&&m.reconnect!=="none";t?(U(),G()):K(!1)}function Z(e){if(e.successful){a=e.clientId;var n=i.negotiateTransport(e.supportedConnectionTypes,e.version,r,E.url);if(n===null)throw"Could not negotiate transport with server; client "+i.findTransportTypes(e.version,r,E.url)+", server "+e.supportedConnectionTypes;s!==n&&(t._debug("Transport",s,"->",n),s=n),c=!1,W(),e.reestablish=b,b=!0,P("/meta/handshake",e);var o=L()?"none":m.reconnect;switch(o){case"retry":R(),$();break;case"none":K(!1);break;default:throw"Unrecognized advice action "+o}}else Y(e)}function et(e,t){Y({successful:!1,failure:!0,channel:"/meta/handshake",request:t,xhr:e,advice:{reconnect:"retry",interval:p}})}function tt(e){P("/meta/connect",e),P("/meta/unsuccessful",e);var t=L()?"none":m.reconnect;switch(t){case"retry":$(),U();break;case"handshake":i.reset(),R(),G();break;case"none":K(!1);break;default:throw"Unrecognized advice action"+t}}function nt(e){w=e.successful;if(w){P("/meta/connect",e);var t=L()?"none":m.reconnect;switch(t){case"retry":R(),$();break;case"none":K(!1);break;default:throw"Unrecognized advice action "+t}}else tt(e)}function rt(e,t){w=!1,tt({successful:!1,failure:!0,channel:"/meta/connect",request:t,xhr:e,advice:{reconnect:"retry",interval:p}})}function it(e){K(!0),P("/meta/disconnect",e),P("/meta/unsuccessful",e)}function st(e){e.successful?(K(!1),P("/meta/disconnect",e)):it(e)}function ot(e,t){it({successful:!1,failure:!0,channel:"/meta/disconnect",request:t,xhr:e,advice:{reconnect:"none",interval:0}})}function ut(e){P("/meta/subscribe",e),P("/meta/unsuccessful",e)}function at(e){e.successful?P("/meta/subscribe",e):ut(e)}function ft(e,t){ut({successful:!1,failure:!0,channel:"/meta/subscribe",request:t,xhr:e,advice:{reconnect:"none",interval:0}})}function lt(e){P("/meta/unsubscribe",e),P("/meta/unsuccessful",e)}function ct(e){e.successful?P("/meta/unsubscribe",e):lt(e)}function ht(e,t){lt({successful:!1,failure:!0,channel:"/meta/unsubscribe",request:t,xhr:e,advice:{reconnect:"none",interval:0}})}function pt(e){var n=y[e.id];x(n)&&(delete y[e.id],n.call(t,e))}function dt(e){pt(e),P("/meta/publish",e),P("/meta/unsuccessful",e)}function vt(e){e.successful===undefined?e.data?P(e.channel,e):t._debug("Unknown message",e):e.successful?(pt(e),P("/meta/publish",e)):dt(e)}function mt(e,t){dt({successful:!1,failure:!0,channel:t.channel,request:t,xhr:e,advice:{reconnect:"none",interval:0}})}function gt(e){e=M(e);if(e===undefined||e===null)return;J(e.advice);var t=e.channel;switch(t){case"/meta/handshake":Z(e);break;case"/meta/connect":nt(e);break;case"/meta/disconnect":st(e);break;case"/meta/subscribe":at(e);break;case"/meta/unsubscribe":ct(e);break;default:vt(e)}}function yt(e){var t=h[e];if(t)for(var n=0;n<t.length;++n)if(t[n])return!0;return!1}function bt(e,t){var n={scope:e,method:t};if(x(e))n.scope=undefined,n.method=e;else if(S(t)){if(!e)throw"Invalid scope "+e;n.method=e[t];if(!x(n.method))throw"Invalid callback "+t+" for scope "+e}else if(!x(t))throw"Invalid callback "+t;return n}function wt(e,n,r,i){var s=bt(n,r);t._debug("Adding listener on",e,"with scope",s.scope,"and callback",s.method);var o={channel:e,scope:s.scope,callback:s.method,listener:i},u=h[e];u||(u=[],h[e]=u);var a=u.push(o)-1;return o.id=a,o.handle=[e,a],t._debug("Added listener",o,"for channel",e,"having id =",a),o.handle}function Et(e){var n=h[e[0]];n&&(delete n[e[1]],t._debug("Removed listener",e))}var t=this,n=e||"default",r=!1,i=new org.cometd.TransportRegistry,s,o="disconnected",u=0,a=null,f=0,l=[],c=!1,h={},p=0,d=null,v=[],m={},g,y={},b=!1,w=!1,E={connectTimeout:0,maxConnections:2,backoffIncrement:1e3,maxBackoff:6e4,logLevel:"info",reverseIncomingExtensions:!0,maxNetworkDelay:1e4,requestHeaders:{},appendMessageTypeToURL:!0,autoBatch:!1,advice:{timeout:6e4,interval:0,reconnect:"retry"}};this._mixin=function(e,t,n){var r=t||{};for(var i=2;i<arguments.length;++i){var s=arguments[i];if(s===undefined||s===null)continue;for(var o in s){var u=s[o],a=r[o];if(u===t)continue;if(u===undefined)continue;if(e&&typeof u=="object"&&u!==null)if(u instanceof Array)r[o]=this._mixin(e,a instanceof Array?a:[],u);else{var f=typeof a!="object"||a instanceof Array?{}:a;r[o]=this._mixin(e,f,u)}else r[o]=u}}return r},this._warn=function(){T("warn",arguments)},this._info=function(){E.logLevel!=="warn"&&T("info",arguments)},this._debug=function(){E.logLevel==="debug"&&T("debug",arguments)},this._isCrossDomain=function(e){return e&&e!==window.location.host};var j,F;this.send=q,this.receive=gt,j=function(e){t._debug("Received",e);for(var n=0;n<e.length;++n){var r=e[n];gt(r)}},F=function(e,n,r,i){t._debug("handleFailure",e,n,r,i);for(var s=0;s<n.length;++s){var o=n[s],u=o.channel;switch(u){case"/meta/handshake":et(e,o);break;case"/meta/connect":rt(e,o);break;case"/meta/disconnect":ot(e,o);break;case"/meta/subscribe":ft(e,o);break;case"/meta/unsubscribe":ht(e,o);break;default:mt(e,o)}}},this.registerTransport=function(e,t,n){var r=i.add(e,t,n);return r&&(this._debug("Registered transport",e),x(t.registered)&&t.registered(e,this)),r},this.getTransportTypes=function(){return i.getTransportTypes()},this.unregisterTransport=function(e){var t=i.remove(e);return t!==null&&(this._debug("Unregistered transport",e),x(t.unregistered)&&t.unregistered()),t},this.unregisterTransports=function(){i.clear()},this.findTransport=function(e){return i.find(e)},this.configure=function(e){N.call(this,e)},this.init=function(e,t){this.configure(e),this.handshake(t)},this.handshake=function(e){k("disconnected"),b=!1,Q(e)},this.disconnect=function(e,t){if(L())return;t===undefined&&typeof e!="boolean"&&(t=e,e=!1);var n={channel:"/meta/disconnect"},r=this._mixin(!1,{},t,n);k("disconnecting"),I(e===!0,[r],!1,"disconnect")},this.startBatch=function(){z()},this.endBatch=function(){X()},this.batch=function(e,t){var n=bt(e,t);this.startBatch();try{n.method.call(n.scope),this.endBatch()}catch(r){throw this._debug("Exception during execution of batch",r),this.endBatch(),r}},this.addListener=function(e,t,n){if(arguments.length<2)throw"Illegal arguments number: required 2, got "+arguments.length;if(!S(e))throw"Illegal argument type: channel must be a string";return wt(e,t,n,!0)},this.removeListener=function(e){if(!org.cometd.Utils.isArray(e))throw"Invalid argument: expected subscription, not "+e;Et(e)},this.clearListeners=function(){h={}},this.subscribe=function(e,t,n,r){if(arguments.length<2)throw"Illegal arguments number: required 2, got "+arguments.length;if(!S(e))throw"Illegal argument type: channel must be a string";if(L())throw"Illegal state: already disconnected";x(t)&&(r=n,n=t,t=undefined);var i=!yt(e),s=wt(e,t,n,!1);if(i){var o={channel:"/meta/subscribe",subscription:e},u=this._mixin(!1,{},r,o);q(u)}return s},this.unsubscribe=function(e,t){if(arguments.length<1)throw"Illegal arguments number: required 1, got "+arguments.length;if(L())throw"Illegal state: already disconnected";this.removeListener(e);var n=e[0];if(!yt(n)){var r={channel:"/meta/unsubscribe",subscription:n},i=this._mixin(!1,{},t,r);q(i)}},this.clearSubscriptions=function(){C()},this.publish=function(e,t,n,r){if(arguments.length<1)throw"Illegal arguments number: required 1, got "+arguments.length;if(!S(e))throw"Illegal argument type: channel must be a string";if(L())throw"Illegal state: already disconnected";x(t)?(r=t,t=n={}):x(n)&&(r=n,n={});var i={channel:e,data:t,_callback:r},s=this._mixin(!1,{},n,i);q(s)},this.getStatus=function(){return o},this.isDisconnected=L,this.setBackoffIncrement=function(e){E.backoffIncrement=e},this.getBackoffIncrement=function(){return E.backoffIncrement},this.getBackoffPeriod=function(){return p},this.setLogLevel=function(e){E.logLevel=e},this.registerExtension=function(e,t){if(arguments.length<2)throw"Illegal arguments number: required 2, got "+arguments.length;if(!S(e))throw"Illegal argument type: extension name must be a string";var n=!1;for(var r=0;r<v.length;++r){var i=v[r];if(i.name===e){n=!0;break}}return n?(this._info("Could not register extension with name",e,"since another extension with the same name already exists"),!1):(v.push({name:e,extension:t}),this._debug("Registered extension",e),x(t.registered)&&t.registered(e,this),!0)},this.unregisterExtension=function(e){if(!S(e))throw"Illegal argument type: extension name must be a string";var t=!1;for(var n=0;n<v.length;++n){var r=v[n];if(r.name===e){v.splice(n,1),t=!0,this._debug("Unregistered extension",e);var i=r.extension;x(i.unregistered)&&i.unregistered();break}}return t},this.getExtension=function(e){for(var t=0;t<v.length;++t){var n=v[t];if(n.name===e)return n.extension}return null},this.getName=function(){return n},this.getClientId=function(){return a},this.getURL=function(){return E.url},this.getTransport=function(){return s},this.getConfiguration=function(){return this._mixin(!0,{},E)},this.getAdvice=function(){return this._mixin(!0,{},m)},org.cometd.WebSocket=window.WebSocket,org.cometd.WebSocket||(org.cometd.WebSocket=window.MozWebSocket)},typeof define=="function"&&define.amd&&define("bundles/framework/bundle/mapwfs2/comp",[],function(){return org.cometd}),function(e){function t(e,t){function n(e,t){if(t)for(var n in t){if(n.toLowerCase()==="content-type")continue;e.setRequestHeader(n,t[n])}}function r(){var r=new t.LongPollingTransport,i=t.Transport.derive(r);return i.xhrSend=function(t){return e.ajax({url:t.url,async:t.sync!==!0,type:"POST",contentType:"application/json;charset=UTF-8",data:t.body,xhrFields:{withCredentials:!0},beforeSend:function(e){return n(e,t.headers),!0},success:t.onSuccess,error:function(e,n,r){t.onError(n,r)}})},i}function i(){var r=new t.CallbackPollingTransport,i=t.Transport.derive(r);return i.jsonpSend=function(t){e.ajax({url:t.url,async:t.sync!==!0,type:"GET",dataType:"jsonp",jsonp:"jsonp",data:{message:t.body},beforeSend:function(e){return n(e,t.headers),!0},success:t.onSuccess,error:function(e,n,r){t.onError(n,r)}})},i}return t.JSON.toJSON=JSON.stringify,t.JSON.fromJSON=JSON.parse,e.Cometd=function(e){var n=new t.Cometd(e);return t.WebSocket&&n.registerTransport("websocket",new t.WebSocketTransport),n.registerTransport("long-polling",new r),n.registerTransport("callback-polling",new i),n},e.cometd=new e.Cometd,e.cometd}t(e,org.cometd)}(jQuery),function(e,t,n){function i(e){return e}function s(e){return decodeURIComponent(e.replace(r," "))}var r=/\+/g,o=e.cookie=function(r,u,a){if(u!==n){a=e.extend({},o.defaults,a),u===null&&(a.expires=-1);if(typeof a.expires=="number"){var f=a.expires,l=a.expires=new Date;l.setDate(l.getDate()+f)}return u=o.json?JSON.stringify(u):String(u),t.cookie=[encodeURIComponent(r),"=",o.raw?u:encodeURIComponent(u),a.expires?"; expires="+a.expires.toUTCString():"",a.path?"; path="+a.path:"",a.domain?"; domain="+a.domain:"",a.secure?"; secure":""].join("")}var c=o.raw?i:s,h=t.cookie.split("; ");for(var p=0,d;d=h[p]&&h[p].split("=");p++)if(c(d.shift())===r){var v=c(d.join("="));return o.json?JSON.parse(v):v}return null};o.defaults={},e.removeCookie=function(t,n){return e.cookie(t)!==null?(e.cookie(t,null,n),!0):!1}}(jQuery,document),define("libraries/jquery/plugins/jquery.cookie",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs2.service.Connection",function(e,t){this.config=e,this.plugin=t,this.cometd=jQuery.cometd,this._connected=!1,this._errorSub=null,this._connectionProblemWaitTime=5e3,typeof this.config.lazy=="undefined"&&(this.config.lazy=!0),this._lazy=this.config.lazy,this._disconnectTime=this.config.disconnectTime||3e4,this._backoffIncrement=this.config.backoffIncrement||1e3,this._maxBackoff=this.config.maxBackoff||6e4,this._maxNetworkDelay=this.config.maxNetworkDelay||1e4,this.browser={},this.getBrowser(),this.cometURL=location.protocol+"//"+this.config.hostname+this.config.port+this.config.contextPath+"/cometd",this.cometd.configure({url:this.cometURL,backoffIncrement:this._backoffIncrement,maxBackoff:this._maxBackoff,maxNetworkDelay:this._maxNetworkDelay});var n=this;this.cometd.addListener("/meta/handshake",function(){n._metaHandshake.apply(n,arguments)}),this.cometd.addListener("/meta/connect",function(){n._metaConnect.apply(n,arguments)}),this._lazy||this.connect(),jQuery(window).unload(function(){n.disconnect()})},{connect:function(){this.cometd.handshake()},disconnect:function(){this.cometd.disconnect(!0)},isConnected:function(){return this._connected},isLazy:function(){return this._lazy},get:function(){return this.cometd},getBrowser:function(){this.browser={name:"",versionNum:""},jQuery.browser.msie?this.browser.name="msie":jQuery.browser.chrome?this.browser.name="chrome":jQuery.browser.mozilla?this.browser.name="mozilla":jQuery.browser.safari?this.browser.name="safari":this.browser.name="unknown",this.browser.versionNum=parseInt(jQuery.browser.version,10)},updateLazyDisconnect:function(e){if(this.isLazy())if(!e){var t=this;this._disconnectTimer=setTimeout(function(){t.disconnect()},this._disconnectTime)}else this._disconnectTimer&&(clearTimeout(this._disconnectTimer),this._disconnectTimer=null)},_metaConnect:function(e){if(this.cometd.isDisconnected()){this._connected=!1;return}var t=this._connected;this._connected=e.successful===!0;if(!t&&this._connected)this._brokenConnectionTimer&&(clearTimeout(this._brokenConnectionTimer),this._brokenConnectionTimer=null),this.plugin.clearConnectionErrorTriggers();else if(t&&!this._connected){var n=this;this._brokenConnectionTimer=setTimeout(function(){n.plugin.showErrorPopup("connection_broken",null,!0)},this._connectionProblemWaitTime)}},_metaHandshake:function(e){if(e.successful===!0){this._connectionNotAvailableTimer&&(clearTimeout(this._connectionNotAvailableTimer),this._connectionNotAvailableTimer=null);var t=this;this.cometd.batch(function(){t._errorSub=t.cometd.subscribe("/error",t.getError),t.plugin.getIO().subscribe(),t.plugin.getIO().startup({clientId:e.clientId,browser:t.browser.name,browserVersion:t.browser.versionNum})})}else{var t=this;this._connectionNotAvailableTimer=setTimeout(function(){t.plugin.showErrorPopup("connection_not_available",null,!0)},this._connectionProblemWaitTime)}},getError:function(e){var t=e.data.message,n=this.plugin.getSandbox().findMapLayerFromSelectedMapLayers(e.data.layerId),r=e.data.once;this.plugin.showErrorPopup(t,n,r)}}),define("bundles/framework/bundle/mapwfs2/service/Connection",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs2.service.Mediator",function(e,t){this.config=e,this.plugin=t,this.connection=this.plugin.getConnection(),this.cometd=this.connection.get(),this.layerProperties={},this.rootURL=location.protocol+"//"+this.config.hostname+this.config.port+this.config.contextPath,this.session={session:jQuery.cookie("JSESSIONID")||"",route:jQuery.cookie("ROUTEID")||""},this._previousTimer=null,this._featureUpdateFrequence=200},{getSessionID:function(){return this.session.session},getRootURL:function(){return this.rootURL},subscribe:function(){var e=this,t={"/wfs/properties":function(){e.getWFSProperties.apply(e,arguments)},"/wfs/feature":function(){e.getWFSFeature.apply(e,arguments)},"/wfs/mapClick":function(){e.getWFSMapClick.apply(e,arguments)},"/wfs/filter":function(){e.getWFSFilter.apply(e,arguments)},"/wfs/image":function(){e.getWFSImage.apply(e,arguments)},"/wfs/reset":function(){e.resetWFS.apply(e,arguments)}};for(var n in t)this.cometd.subscribe(n,t[n])},startup:function(e){var t=this;e&&(this.session=e),this.session.session=jQuery.cookie("JSESSIONID")||"",this.session.route=jQuery.cookie("ROUTEID")||"";var n=this.plugin.getSandbox().findAllSelectedMapLayers(),r={};for(var i=0;i<n.length;++i)n[i].hasFeatureData()&&(r[n[i].getId()+""]={styleName:n[i].getCurrentStyle().getName()});var s=this.plugin.getSandbox().getMap().getSrsName(),o=this.plugin.getSandbox().getMap().getExtent(),u=this.plugin.getSandbox().getMap().getZoom(),a=this.plugin.mapModule.getMapScales(),f=this.plugin.getGrid();f==null&&(f={});var l=this.plugin.getTileSize();l==null&&(l={}),this.cometd.publish("/service/wfs/init",{session:this.session.session,route:this.session.route,language:Oskari.getLang(),browser:this.session.browser,browserVersion:this.session.browserVersion,location:{srs:s,bbox:[o.left,o.bottom,o.right,o.top],zoom:u},grid:f,tileSize:l,mapSize:{width:t.plugin.getSandbox().getMap().getWidth(),height:t.plugin.getSandbox().getMap().getHeight()},mapScales:a,layers:r})}}),Oskari.clazz.category("Oskari.mapframework.bundle.mapwfs2.service.Mediator","getters",{getWFSProperties:function(e){var t=this.plugin.getSandbox().findMapLayerFromSelectedMapLayers(e.data.layerId);if(t.getLayerType()!="analysis"){var n=t.getFields(),r=t.getLocales();n.length>0&&!this.plugin.isArrayEqual(e.data.fields,n)&&!this.plugin.isArrayEqual(e.data.locales,r)&&this.plugin.mapMoveHandler(),t.setFields(e.data.fields),t.setLocales(e.data.locales)}var i=this;this._propertyTimer&&(clearTimeout(this._propertyTimer),this._propertyTimer=null),this._propertyTimer=setTimeout(function(){var e=i.plugin.getSandbox().getEventBuilder("WFSPropertiesEvent")(t);i.plugin.getSandbox().notifyAll(e)},this._featureUpdateFrequence)},getWFSFeature:function(e){var t=this.plugin.getSandbox().findMapLayerFromSelectedMapLayers(e.data.layerId);e.data.feature!="empty"&&e.data.feature!="max"&&t.setActiveFeature(e.data.feature);var n=this;this._featureTimer&&(clearTimeout(this._featureTimer),this._featureTimer=null),this._featureTimer=setTimeout(function(){var r=n.plugin.getSandbox().getEventBuilder("WFSFeatureEvent")(t,e.data.feature);n.plugin.getSandbox().notifyAll(r)},this._featureUpdateFrequence)},getWFSMapClick:function(e){var t=this.plugin.getSandbox().findMapLayerFromSelectedMapLayers(e.data.layerId),n=e.data.keepPrevious,r=[];if(e.data.features!="empty"){t.setSelectedFeatures([]);for(var i=0;i<e.data.features.length;++i)r.push(e.data.features[i][0])}n?t.setClickedFeatureIds(t.getClickedFeatureIds().concat(r)):t.setClickedFeatureIds(r),this.plugin.getmapClickData().wfs.push(e.data),this.plugin.getLayerCount()==this.plugin.getmapClickData().wfs.length&&(this.plugin.getmapClickData().comet=!0,this.plugin.getmapClickData().ajax&&this.plugin.showInfoBox());var s=this.plugin.getSandbox().getEventBuilder("WFSFeaturesSelectedEvent")(r,t,n);this.plugin.getSandbox().notifyAll(s)},getWFSFilter:function(e){var t=this.plugin.getSandbox().findMapLayerFromSelectedMapLayers(e.data.layerId),n=[];if(e.data.features!="empty"){t.setClickedFeatureIds([]);for(var r=0;r<e.data.features.length;++r)n.push(e.data.features[r][0])}e.data.features!="empty"?t.setSelectedFeatures(e.data.features):t.setSelectedFeatures([]);var i=this.plugin.getSandbox().getEventBuilder("WFSFeaturesSelectedEvent")(n,t,!1);this.plugin.getSandbox().notifyAll(i)},getWFSImage:function(e){var t=this.plugin.getSandbox().findMapLayerFromSelectedMapLayers(e.data.layerId),n="";try{typeof e.data.data!="undefined"?n="data:image/png;base64,"+e.data.data:n=this.rootURL+e.data.url+"&session="+this.session.session}catch(r){this.plugin.getSandbox().printDebug(r)}var i=e.data.type,s=e.data.boundaryTile,o=e.data.keepPrevious,u={width:e.data.width,height:e.data.height},a=this.plugin.getSandbox().getEventBuilder("WFSImageEvent")(t,n,e.data.bbox,u,i,s,o);this.plugin.getSandbox().notifyAll(a);if(i=="normal"){this.plugin.setPrintTile(t,e.data.bbox,this.rootURL+e.data.url+"&session="+this.session.session);var f=this.plugin.getSandbox().getEventBuilder("Printout.PrintableContentEvent");if(f){var a=f(this.plugin.getName(),t,this.plugin.getPrintTiles(),null);this.plugin.getSandbox().notifyAll(a)}}},resetWFS:function(e){this.startup(null)}}),Oskari.clazz.category("Oskari.mapframework.bundle.mapwfs2.service.Mediator","setters",{addMapLayer:function(e,t){this.connection.isConnected()&&this.cometd.publish("/service/wfs/addMapLayer",{layerId:e,styleName:t})},removeMapLayer:function(e){this.connection.isConnected()&&this.cometd.publish("/service/wfs/removeMapLayer",{layerId:e})},highlightMapLayerFeatures:function(e,t,n){this.connection.isConnected()&&this.cometd.publish("/service/wfs/highlightFeatures",{layerId:e,featureIds:t,keepPrevious:n})},setLocation:function(e,t,n,r,i,s){this.connection.isConnected()&&this.cometd.publish("/service/wfs/setLocation",{layerId:e,srs:t,bbox:n,zoom:r,grid:i,tiles:s})},setMapSize:function(e,t){this.connection.isConnected()&&this.cometd.publish("/service/wfs/setMapSize",{width:e,height:t})},setMapLayerStyle:function(e,t){this.connection.isConnected()&&this.cometd.publish("/service/wfs/setMapLayerStyle",{layerId:e,styleName:t})},setMapLayerCustomStyle:function(e,t){this.connection.isConnected()&&this.cometd.publish("/service/wfs/setMapLayerCustomStyle",{layerId:e,fill_color:t.area.fillColor,fill_pattern:t.area.fillStyle,border_color:t.area.lineColor,border_linejoin:t.area.lineCorner,border_dasharray:t.area.lineStyle,border_width:t.area.lineWidth,stroke_linecap:t.line.cap,stroke_color:t.line.color,stroke_linejoin:t.line.corner,stroke_dasharray:t.line.style,stroke_width:t.line.width,dot_color:t.point.color,dot_shape:t.point.shape,dot_size:t.point.size})},setMapClick:function(e,t,n){this.connection.isConnected()&&this.cometd.publish("/service/wfs/setMapClick",{longitude:e,latitude:t,keepPrevious:n})},setFilter:function(e){filter={geojson:e},this.connection.isConnected()&&this.cometd.publish("/service/wfs/setFilter",{filter:filter})},setMapLayerVisibility:function(e,t){this.connection.isConnected()&&this.cometd.publish("/service/wfs/setMapLayerVisibility",{layerId:e,visible:t})}}),define("bundles/framework/bundle/mapwfs2/service/Mediator",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs2.plugin.QueuedTilesGrid",function(e){this.grid=[],this.map=null,this.tileSize=null,this.maxExtent=null,this.buffer=0,this.numLoadingTiles=0;for(p in e)this[p]=e[p]},{destroy:function(){this.clearGrid(),this.grid=null,this.tileSize=null},clearGrid:function(){if(this.grid){for(var e=0,t=this.grid.length;e<t;e++){var n=this.grid[e];for(var r=0,i=n.length;r<i;r++){var s=n[r];s.destroy()}}this.grid=[]}},moveTo:function(e,t){e=e||this.map.getExtent();if(e!=null){var n=!this.grid.length||t,r=this.getTilesBounds();n||!r.containsBounds(e,!0)?this.initGriddedTiles(e):this.moveGriddedTiles(e)}},setTileSize:function(e){},getTilesBounds:function(){var e=null;if(this.grid.length){var t=this.grid.length-1,n=this.grid[t][0],r=this.grid[0].length-1,i=this.grid[0][r];e=new OpenLayers.Bounds(n.bounds.left,n.bounds.bottom,i.bounds.right,i.bounds.top)}return e},calculateGridLayout:function(e,t,n){var r=n*this.tileSize.w,i=n*this.tileSize.h,s=e.left-t.left,o=Math.floor(s/r)-this.buffer,u=s/r-o,a=-u*this.tileSize.w,f=t.left+o*r,l=e.top-(t.bottom+i),c=Math.ceil(l/i)+this.buffer,h=c-l/i,p=-h*this.tileSize.h,d=t.bottom+c*i;return{tilelon:r,tilelat:i,tileoffsetlon:f,tileoffsetlat:d,tileoffsetx:a,tileoffsety:p}},initGriddedTiles:function(e){var t=this.map.getSize(),n=Math.ceil(t.h/this.tileSize.h)+Math.max(1,2*this.buffer),r=Math.ceil(t.w/this.tileSize.w)+Math.max(1,2*this.buffer),i=this.maxExtent,s=this.map.getResolution(),o=this.calculateGridLayout(e,i,s),u=Math.round(o.tileoffsetx),a=Math.round(o.tileoffsety),f=o.tileoffsetlon,l=o.tileoffsetlat,c=o.tilelon,h=o.tilelat;this.origin=new OpenLayers.Pixel(u,a);var p=u,d=f,v=0,m=parseInt(this.map.layerContainerDiv.style.left),g=parseInt(this.map.layerContainerDiv.style.top);do{var y=this.grid[v++];y||(y=[],this.grid.push(y)),f=d,u=p;var b=0;do{var w=new OpenLayers.Bounds(f,l,f+c,l+h),E=u;E-=m;var S=a;S-=g;var x=new OpenLayers.Pixel(E,S),T=y[b++];T?T.moveTo(w,x,!1):(T=this.addTile(w,x),y.push(T)),f+=c,u+=this.tileSize.w}while(f<=e.right+c*this.buffer||b<r);l-=h,a+=this.tileSize.h}while(l>=e.bottom-h*this.buffer||v<n);this.removeExcessTiles(v,b)},addTile:function(e,t){return new OpenLayers.Tile(this.layer,e,t,"",this.tileSize)},moveGriddedTiles:function(e){var t=this.buffer||1;for(;;){var n=this.grid[0][0].position,r=this.map.getViewPortPxFromLayerPx(n);if(r.x>-this.tileSize.w*(t-1))this.shiftColumn(!0);else if(r.x<-this.tileSize.w*t)this.shiftColumn(!1);else if(r.y>-this.tileSize.h*(t-1))this.shiftRow(!0);else{if(!(r.y<-this.tileSize.h*t))break;this.shiftRow(!1)}}},shiftRow:function(e){var t=e?0:this.grid.length-1,n=this.grid,r=n[t],i=this.map.getResolution(),s=e?-this.tileSize.h:this.tileSize.h,o=i*-s,u=e?n.pop():n.shift();for(var a=0,f=r.length;a<f;a++){var l=r[a],c=l.bounds.clone(),h=l.position.clone();c.bottom=c.bottom+o,c.top=c.top+o,h.y=h.y+s,u[a].moveTo(c,h)}e?n.unshift(u):n.push(u)},shiftColumn:function(e){var t=e?-this.tileSize.w:this.tileSize.w,n=this.map.getResolution(),r=n*t;for(var i=0,s=this.grid.length;i<s;i++){var o=this.grid[i],u=e?0:o.length-1,a=o[u],f=a.bounds.clone(),l=a.position.clone();f.left=f.left+r,f.right=f.right+r,l.x=l.x+t;var c=e?this.grid[i].pop():this.grid[i].shift();c.moveTo(f,l),e?o.unshift(c):o.push(c)}},removeExcessTiles:function(e,t){while(this.grid.length>e){var n=this.grid.pop();for(var r=0,i=n.length;r<i;r++){var s=n[r];s.destroy()}}while(this.grid[0].length>t)for(var r=0,i=this.grid.length;r<i;r++){var n=this.grid[r],s=n.pop();s.destroy()}},onMapResize:function(){},CLASS_NAME:"NLSFI.OpenLayers.Strategy.QueuedTilesGrid"}),define("bundles/framework/bundle/mapwfs2/plugin/QueuedTilesGrid",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs2.plugin.QueuedTilesStrategy",function(e){this.debugGridFeatures=!0,this.options=e,this.tileQueue=e.tileQueue,this.autoActivate=!0,this.autoDestroy=!1,this.grid=null,this.bounds=null;for(p in e)this[p]=e[p];this.active=!1},{getGrid:function(){return this.grid},setLayer:function(e){this.layer=e},flushTileQueue:function(){var e=this.tileQueue.queue,t=[];for(var n=0;n<e.length;n++)e[n].tileFeature!=null&&(t.push(e[n].tileFeature),e[n].tileFeature=null);t.length>0&&this.layer.destroyFeatures(t),this.tileQueue.flushQueue()},unloadOutOfViewFeatures:function(){},ratio:1,activate:function(){return this.active?!1:(this.active=!0,this.grid=Oskari.clazz.create("Oskari.mapframework.bundle.mapwfs2.plugin.QueuedTilesGrid",{map:this.layer.map,layer:this.layer,maxExtent:this.layer.map.getMaxExtent(),tileSize:this.layer.map.getTileSize()}),this.layer.events.on({refresh:this.updateRefresh,scope:this}),!0)},deactivate:function(){return this.active?(this.layer.events.un({refresh:this.update,scope:this}),this.grid.destroy(),this.grid=null,!0):!1},updateRefresh:function(e){this.update()},updateMoveEnd:function(e){this.update()},update:function(e){var t=this.layer.map.getExtent();this.grid.moveTo(t,!0),this.flushTileQueue();var n=this.layer.map.getZoom();if(n<this.minZoom)return;this.triggerRead()},invalidBounds:function(e){return e||(e=this.layer.map.getExtent()),!this.bounds||!this.bounds.containsBounds(e)},triggerUnload:function(e){this.layer.destroyFeatures()},triggerRead:function(){var e=this.grid.grid,t=[],n=this.debugGridFeatures;for(var r=0;r<e.length;r++)for(var i=0;i<e[r].length;i++){var s=e[r][i].bounds.clone(),o={left:s.left,top:s.top,right:s.right,bottom:s.bottom},u=null;if(n){var a=new OpenLayers.Geometry.Point(s.left,s.bottom),f=new OpenLayers.Geometry.Point(s.right,s.top),l=new OpenLayers.Geometry.Point(s.left,s.top),c=new OpenLayers.Geometry.Point(s.right,s.bottom),h=new OpenLayers.Geometry.LineString([a,c,f,l,a]),u=new OpenLayers.Feature.Vector(h,{featureClassName:this.CLASS_NAME,description:""});u.renderIntent="tile",t.push(u)}var p=Oskari.clazz.create("Oskari.mapframework.bundle.mapwfs2.domain.QueuedTile",{bounds:o,tileFeature:u});this.tileQueue.pushJob(p)}n&&this.layer.addFeatures(t)},merge:function(e){var t=e.features;t&&t.length>0&&this.layer.addFeatures(t)},CLASS_NAME:"NLSFI.OpenLayers.Strategy.QueuedTilesStrategy"}),define("bundles/framework/bundle/mapwfs2/plugin/QueuedTilesStrategy",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs2.plugin.TileCache",function(){this.data={},this.ts={}},{mget:function(e,t,n){var r=this.data[e];if(!r)return;var i=r[t];if(!i)return;return i[n]},mput:function(e,t,n,r){var i=this.data[e];i||(i={},this.data[e]=i);var s=i[t];s||(s={},i[t]=s),s[n]=r;var o=this.ts[e];o||(o={},this.ts[e]=o);var u=o[t];u||(u={},o[t]=u),u[n]=(new Date).getTime()},mdel:function(e,t,n){var r=this.data[e];if(!r)return;var i=r[t];if(!i)return;if(n==null){i=undefined,delete r[t];return}var s=i[n];if(!s)return;s=undefined,delete i[n]},purgeOffset:function(e){var t=(new Date).getTime()-e;for(var n in this.data)for(var r in this.data[n])for(var i in this.data[n][r])this.ts[n][r][i]<t&&(delete this.data[n][r][i],delete this.ts[n][r][i])}}),define("bundles/framework/bundle/mapwfs2/plugin/TileCache",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs2.plugin.WfsLayerPlugin",function(e){this.config=e,this._sandbox=null,this._map=null,this.mapModule=null,this.pluginName=null,this._connection=null,this._io=null,this.tileSize=null,this.zoomLevel=null,this._isWFSOpen=0,this._printTiles={},this._tiles={},this._tilesToUpdate=null,this._tileData=null,this._tileDataTemp=null,this._mapClickData={comet:!1,ajax:!1,wfs:[]},this.errorTriggers={connection_not_available:{limit:1,count:0},connection_broken:{limit:1,count:0}},this.activeHighlightLayers=[],this.template={};for(p in this.__templates)this.template[p]=jQuery(this.__templates[p])},{__name:"WfsLayerPlugin",__templates:{getinfo_result_header:'<div class="getinforesult_header"><div class="icon-bubble-left"></div>',getinfo_result_header_title:'<div class="getinforesult_header_title"></div>',wrapper:"<div></div>",getinfo_result_table:'<table class="getinforesult_table"></table>',link_outside:'<a target="_blank"></a>',tableRow:"<tr></tr>",tableCell:"<td></td>"},__layerPrefix:"wfs_layer_",__typeHighlight:"highlight",__typeNormal:"normal",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this.pluginName=e.getName()+this.__name},init:function(){var e=(this.config?this.config.sandbox:null)||"sandbox",t=Oskari.getSandbox(e);this._sandbox=t,this.config&&(this.config.hostname=="localhost"&&(this.config.hostname=location.hostname),this.config.port.length>0&&(this.config.port=":"+this.config.port)),this._connection=Oskari.clazz.create("Oskari.mapframework.bundle.mapwfs2.service.Connection",this.config,this),this._io=Oskari.clazz.create("Oskari.mapframework.bundle.mapwfs2.service.Mediator",this.config,this);var n=t.getService("Oskari.mapframework.service.MapLayerService");if(n){n.registerLayerModel("wfslayer","Oskari.mapframework.bundle.mapwfs2.domain.WFSLayer");var r=Oskari.clazz.create("Oskari.mapframework.bundle.mapwfs2.domain.WfsLayerModelBuilder",t);n.registerLayerModelBuilder("wfslayer",r)}this._tilesToUpdate=Oskari.clazz.create("Oskari.mapframework.bundle.mapwfs2.plugin.TileCache"),this._tileData=Oskari.clazz.create("Oskari.mapframework.bundle.mapwfs2.plugin.TileCache"),this._tileDataTemp=Oskari.clazz.create("Oskari.mapframework.bundle.mapwfs2.plugin.TileCache"),this._visualizationForm=Oskari.clazz.create("Oskari.userinterface.component.VisualizationForm")},register:function(){this.getMapModule().setLayerPlugin("wfslayer",this)},unregister:function(){this.getMapModule().setLayerPlugin("wfslayer",null)},startPlugin:function(e){this._map=this.getMapModule().getMap(),this.createTilesGrid(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this.requestHandlers={showOwnStyleHandler:Oskari.clazz.create("Oskari.mapframework.bundle.mapwfs2.request.ShowOwnStyleRequestHandler",this)},e.addRequestHandler("ShowOwnStyleRequest",this.requestHandlers.showOwnStyleHandler)},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null},start:function(e){},stop:function(e){},getSandbox:function(){return this._sandbox},getConnection:function(){return this._connection},getIO:function(){return this._io},getVisualizationForm:function(){return this._visualizationForm},getmapClickData:function(){return this._mapClickData},eventHandlers:{AfterMapMoveEvent:function(e){this.mapMoveHandler()},AfterMapLayerAddEvent:function(e){this.mapLayerAddHandler(e)},AfterMapLayerRemoveEvent:function(e){this.mapLayerRemoveHandler(e)},WFSFeaturesSelectedEvent:function(e){this.featuresSelectedHandler(e)},MapClickedEvent:function(e){this.mapClickedHandler(e)},GetInfoResultEvent:function(e){this.getInfoResultHandler(e)},AfterChangeMapLayerStyleEvent:function(e){this.changeMapLayerStyleHandler(e)},MapLayerVisibilityChangedEvent:function(e){this.mapLayerVisibilityChangedHandler(e)},AfterChangeMapLayerOpacityEvent:function(e){this.afterChangeMapLayerOpacityEvent(e)},MapSizeChangedEvent:function(e){this.mapSizeChangedHandler(e)},WFSSetFilter:function(e){this.setFilterHandler(e)},WFSImageEvent:function(e){this.drawImageTile(e.getLayer(),e.getImageUrl(),e.getBBOX(),e.getSize(),e.getLayerType(),e.isBoundaryTile(),e.isKeepPrevious())}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},mapMoveHandler:function(){var e=this.getSandbox().getMap().getSrsName(),t=this.getSandbox().getMap().getExtent(),n=this.getSandbox().getMap().getZoom();this._printTiles={};var r=this.getGrid();this.refreshCaches();var i=this.getSandbox().findAllSelectedMapLayers();for(var s=0;s<i.length;++s)if(i[s].hasFeatureData()){i[s].setActiveFeatures([]);if(r!=null){var o=i[s].getId(),u=this.getNonCachedGrid(o,r);this.getIO().setLocation(o,e,[t.left,t.bottom,t.right,t.top],n,r,u),this._tilesLayer.redraw()}}if(this.zoomLevel!=n){this.zoomLevel=n;for(var a=0;a<this.activeHighlightLayers.length;++a)if(this.getConnection().isLazy()&&!this.getConnection().isConnected()||!this.getSandbox().findMapLayerFromSelectedMapLayers(this.activeHighlightLayers[a].getId())){var e=this.getSandbox().getMap().getSrsName(),t=this.getSandbox().getMap().getExtent(),n=this.getSandbox().getMap().getZoom(),f=this.activeHighlightLayers[a].getClickedFeatureListIds();this.removeHighlightImages(this.activeHighlightLayers[a]),this.getHighlightImage(this.activeHighlightLayers[a],e,[t.left,t.bottom,t.right,t.top],n,f)}for(var l=0;l<i.length;++l)if(i[l].hasFeatureData()){var f=this.getAllFeatureIds(i[l]);this.removeHighlightImages(i[l]),this.getIO().highlightMapLayerFeatures(i[l].getId(),f,!1)}}},mapLayerAddHandler:function(e){if(e.getMapLayer().hasFeatureData()){this.getConnection().isLazy()&&!this.getConnection().isConnected()&&this.getConnection().connect(),this._isWFSOpen++,this.getConnection().updateLazyDisconnect(this.isWFSOpen());var t=null;e.getMapLayer().getCurrentStyle()&&(t=e.getMapLayer().getCurrentStyle().getName());if(t==null||t=="")t="default";this.addMapLayerToMap(e.getMapLayer(),this.__typeNormal);var n=this;this.getConnection().get().batch(function(){n.getIO().addMapLayer(e.getMapLayer().getId(),t),n.mapMoveHandler()})}},mapLayerRemoveHandler:function(e){var t=e.getMapLayer();t.hasFeatureData()&&(this._isWFSOpen--,this.getConnection().updateLazyDisconnect(this.isWFSOpen()),this.getIO().removeMapLayer(t.getId()),this.removeMapLayerFromMap(t),this._printTiles[t.getId()]=[],delete this.errorTriggers["wfs_no_permissions_"+t.getId()],delete this.errorTriggers["wfs_configuring_layer_failed_"+t.getId()],delete this.errorTriggers["wfs_request_failed_"+t.getId()],delete this.errorTriggers["features_parsing_failed_"+t.getId()])},featuresSelectedHandler:function(e){if(e.getMapLayer().hasFeatureData()){var t=e.getMapLayer(),n=t.getClickedFeatureListIds(),r=e.getWfsFeatureIds();if(!e.isKeepSelection())t.setClickedFeatureListIds(e.getWfsFeatureIds());else{var i=!1;for(var s=0;s<r.length;++s){i=!1;for(var o=0;o<n.length;++o)if(r[s]==n[o]){i=!0;continue}i||n.push(r[s])}}e.isKeepSelection()||this.removeHighlightImages();if(this.getConnection().isLazy()&&!this.getConnection().isConnected()||!this.getSandbox().findMapLayerFromSelectedMapLayers(t.getId())){var u=this.getSandbox().getMap().getSrsName(),a=this.getSandbox().getMap().getExtent(),f=this.getSandbox().getMap().getZoom();t.setClickedFeatureListIds(e.getWfsFeatureIds()),this.getHighlightImage(t,u,[a.left,a.bottom,a.right,a.top],f,e.getWfsFeatureIds())}this.getIO().highlightMapLayerFeatures(t.getId(),e.getWfsFeatureIds(),e.isKeepSelection())}},mapClickedHandler:function(e){if(this.getSandbox().getMap().isMoving())return;var t=e.getLonLat(),n=this.getSandbox().isCtrlKeyDown();this.getIO().setMapClick(t.lon,t.lat,n)},getInfoResultHandler:function(e){this._mapClickData.ajax=!0,this._mapClickData.data=e.getData(),(!this.isWFSOpen()||this._mapClickData.comet)&&this.showInfoBox()},changeMapLayerStyleHandler:function(e){if(e.getMapLayer().hasFeatureData()){var t=this.getOLMapLayer(e.getMapLayer(),this.__typeNormal);t.redraw(),this.getIO().setMapLayerStyle(e.getMapLayer().getId(),e.getMapLayer().getCurrentStyle().getName())}},mapLayerVisibilityChangedHandler:function(e){e.getMapLayer().hasFeatureData()&&this.getIO().setMapLayerVisibility(e.getMapLayer().getId(),e.getMapLayer().isVisible())},afterChangeMapLayerOpacityEvent:function(e){var t=e.getMapLayer();if(!t.hasFeatureData())return;var n=this.getOLMapLayers(t);for(var r=0;r<n.length;r++)n[r].setOpacity(t.getOpacity()/100)},mapSizeChangedHandler:function(e){this.getIO().setMapSize(e.getWidth(),e.getHeight());var t=this.getSandbox().getMap().getSrsName(),n=this.getSandbox().getMap().getExtent(),r=this.getSandbox().getMap().getZoom(),i=this.getGrid();this.refreshCaches();var s=this.getSandbox().findAllSelectedMapLayers();for(var o=0;o<s.length;++o)if(s[o].hasFeatureData()){s[o].setActiveFeatures([]);if(i!=null){var u=s[o].getId(),a=this.getNonCachedGrid(u,i);this.getIO().setLocation(u,t,[n.left,n.bottom,n.right,n.top],r,i,a),this._tilesLayer.redraw()}}},setFilterHandler:function(e){var t=this.getSandbox().findAllSelectedMapLayers();for(var n=0;n<t.length;++n)t[n].hasFeatureData()&&t[n].setSelectedFeatures([]);this.getIO().setFilter(e.getGeoJson())},setCustomStyle:function(e,t){this.getIO().setMapLayerCustomStyle(e,t)},clearConnectionErrorTriggers:function(){this.errorTriggers.connection_not_available={limit:1,count:0},this.errorTriggers.connection_broken={limit:1,count:0}},showInfoBox:function(){if(this._mapClickData.data==undefined)return;var e=this._mapClickData.data,t=this._mapClickData.wfs,n=this.formatWFSFeaturesForInfoBox(t);e.fragments=e.fragments.concat(n);if(e.fragments.length==0){this._mapClickData={comet:!1,ajax:!1,wfs:[]};return}var r={},i=this.template.wrapper.clone();r.html="",r.actions={};for(var s=0;s<e.fragments.length;s++){var o=e.fragments[s],u=o.layerName,a=o.markup,f=this.template.wrapper.clone(),l=this.template.getinfo_result_header.clone(),c=this.template.getinfo_result_header_title.clone();c.append(u),l.append(c),f.append(l),a&&f.append(a),i.append(f)}r.html=i;var h=this.getSandbox().getRequestBuilder("InfoBox.ShowInfoBoxRequest")(e.popupid,e.title,[r],e.lonlat,!0,e.colourScheme,e.font);this.getSandbox().request(this,h),this._mapClickData={comet:!1,ajax:!1,wfs:[]}},formatWFSFeaturesForInfoBox:function(e){var t=[],n="wfslayer",r,i,s,o;for(var u=0;u<e.length;u++){if(e[u].features=="empty")continue;r=e[u].layerId,i=this.getSandbox().findMapLayerFromSelectedMapLayers(r);if(i==null)continue;s=i?i.getName():"";var a=[],f,l,c=i.getFields().slice(0),h=i.getLocales();if(h!=null)for(var p=0;p<c.length;p++)h.length>=1&&(c[p]=h[p]);var d=function(e,t){for(var n=0;n<e.length;n++)if(e[n]==t)return!0;return!1},v=[];v.push("__fid"),v.push("__centerX"),v.push("__centerY");for(var m=0;m<e[u].features.length;m++){f={},l=e[u].features[m];for(var g=0;g<c.length;g++){if(d(v,c[g]))continue;l[g]==null||l[g]==""?f[c[g]]="":f[c[g]]=l[g]}a.push(f)}for(var y=0;y<a.length;y++)o=this._json2html(a[y]),t.push({markup:o,layerId:r,layerName:s,type:n})}return t},_json2html:function(e){if(e==null)return"";var t=!0,n=this.template.getinfo_result_table.clone(),r=null,i=null,s=null;for(var o in e){var u=e[o];if(!u||!o)continue;var a=(typeof u).toLowerCase(),f="";switch(a){case"string":u.indexOf("http://")==0?(valpres=this.template.link_outside.clone(),valpres.attr("href",u),valpres.append(u)):valpres=u;break;case"undefined":valpres="n/a";break;case"boolean":valpres=u?"true":"false";break;case"number":valpres=""+u;break;case"function":valpres="?";break;case"object":if(jQuery.isArray(u)){var l=this.template.wrapper.clone();for(var c=0;c<u.length;++c){var h=this._json2html(u[c]);l.append(h)}valpres=l}else valpres=this._json2html(u);break;default:valpres=""}t=!t,r=this.template.tableRow.clone(),t||r.addClass("odd"),i=this.template.tableCell.clone(),i.append(o),r.append(i),s=this.template.tableCell.clone(),s.append(valpres),r.append(s),n.append(r)}return n},preselectLayers:function(e){for(var t=0;t<e.length;t++){var n=e[t],r=n.getId();if(!n.hasFeatureData())continue;this.getSandbox().printDebug("[WfsLayerPlugin] preselecting "+r)}},removeHighlightImages:function(e){if(e&&!e.hasFeatureData())return;var t="(.*)";e&&(t=e.getId());var n=new RegExp(this.__layerPrefix+t+"_"+this.__typeHighlight),r=this._map.getLayersByName(n);for(var i=0;i<r.length;i++)layerIndex=this._map.getLayerIndex(r[i]),r[i].destroy()},removeMapLayerFromMap:function(e){var t=this.getOLMapLayers(e);for(var n=0;n<t.length;n++)t[n].destroy()},getOLMapLayers:function(e){if(e&&!e.hasFeatureData())return;var t="";e&&(t=e.getId());var n=new RegExp(this.__layerPrefix+t+"_(.*)","i");return this._map.getLayersByName(n)},getOLMapLayer:function(e,t){if(!e||!e.hasFeatureData())return null;var n=this.__layerPrefix+e.getId()+"_"+t,r=new RegExp(n);return this._map.getLayersByName(r)[0]},drawImageTile:function(e,t,n,r,i,s,o){var u=this.__layerPrefix+e.getId()+"_"+i,a=new OpenLayers.Bounds(n);if(!t||!e||!a)return;var f=null;if(i==this.__typeHighlight){var l=new OpenLayers.Size(r.width,r.height),c=this.mapModule.calculateLayerScales(e.getMaxScale(),e.getMinScale()),h=new OpenLayers.Layer.Image(u,t,a,l,{scales:c,transparent:!0,format:"image/png",isBaseLayer:!1,displayInLayerSwitcher:!1,visibility:!0,buffer:0});h.opacity=e.getOpacity()/100,this._map.addLayer(h),h.setVisibility(!0),h.redraw(!0),f!==null&&h!==null&&this._map.setLayerIndex(h,f);var p=new RegExp(this.__layerPrefix+e.getId()+"_"+this.__typeNormal),d=new RegExp(this.__layerPrefix+e.getId()+"_"+this.__typeHighlight),v=this._map.getLayersByName(p),m=this._map.getLayersByName(d);if(v.length>0&&m.length>0){var g=this._map.getLayerIndex(v[v.length-1]);this._map.setLayerIndex(m[0],g+10)}}else{var y=a.toArray(!1),b=y.join(","),w=e.getCurrentStyle().getName(),E=this._tilesToUpdate.mget(e.getId(),"",b);if(!s)this._tileData.mput(e.getId(),w,b,t);else{var S=this._tileDataTemp.mget(e.getId(),w,b);if(S)return;this._tileDataTemp.mput(e.getId(),w,b,t)}E&&E.draw()}},addMapLayerToMap:function(e,t){var n=this.__layerPrefix+e.getId()+"_"+t,r=this.getMapModule().calculateLayerScales(e.getMaxScale(),e.getMinScale()),i={layers:"",transparent:!0,id:e.getId(),styles:e.getCurrentStyle().getName(),format:"image/png"},s={layerId:e.getId(),scales:r,isBaseLayer:!1,displayInLayerSwitcher:!0,visibility:!0,buffer:0,_plugin:this,getURL:function(e,t){e=this.adjustBounds(e);var n=e.toArray(!1),r=n.join(","),i=this._plugin.getSandbox().findMapLayerFromSelectedMapLayers(this.layerId),s=i.getCurrentStyle().getName(),o=this._plugin._tileData.mget(this.layerId,s,r);return o?this._plugin._tilesToUpdate.mdel(this.layerId,"",r):(o=this._plugin._tileDataTemp.mget(this.layerId,s,r),this._plugin._tilesToUpdate.mput(this.layerId,"",r,t)),o},addTile:function(e,t){var n=OpenLayers.Util.extend({},this.tileOptions);OpenLayers.Util.extend(n,{setBounds:function(e){e=e.clone();if(this.layer.map.baseLayer.wrapDateLine){var t=this.layer.map.getMaxExtent(),n=this.layer.map.getResolution();e=e.wrapDateLine(t,{leftTolerance:n,rightTolerance:n})}this.bounds=e},renderTile:function(){this.layer.div.appendChild(this.getTile());if(this.layer.async){var e=this.asyncRequestId=(this.asyncRequestId||0)+1;this.layer.getURLasync(this.bounds,function(t){e==this.asyncRequestId&&(this.url=t,this.initImage())},this)}else this.url=this.layer.getURL(this.bounds,this),this.initImage()}});var r=new this.tileClass(this,t,e,null,this.tileSize,n);this._plugin._tiles[r.id]=r;var i=e.toArray(!1),s=i.join(","),o=this._plugin.getSandbox().findMapLayerFromSelectedMapLayers(this.layerId),u=o.getCurrentStyle().getName();return this._plugin._tilesToUpdate.mput(this.layerId,"",s,r),r.events.register("beforedraw",this,this.queueTileDraw),r},destroyTile:function(e){this.removeTileMonitoringHooks(e),delete this._plugin._tiles[e.id],e.destroy()}},o=e.getParams(),u=e.getOptions();for(var a in o)i[a]=o[a];for(var a in u)s[a]=u[a];var f=new OpenLayers.Layer.WMS(n,"",i,s);f.opacity=e.getOpacity()/100,this._map.addLayer(f)},createTilesGrid:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.mapwfs2.domain.TileQueue"),t=Oskari.clazz.create("Oskari.mapframework.bundle.mapwfs2.plugin.QueuedTilesStrategy",{tileQueue:e});t.debugGridFeatures=!1,this.tileQueue=e,this.tileStrategy=t;var n=new OpenLayers.StyleMap({"default":new OpenLayers.Style({pointRadius:3,strokeColor:"red",strokeWidth:2,fillColor:"#800000"}),tile:new OpenLayers.Style({strokeColor:"#008080",strokeWidth:5,fillColor:"#ffcc66",fillOpacity:.5}),select:new OpenLayers.Style({fillColor:"#66ccff",strokeColor:"#3399ff"})});this._tilesLayer=new OpenLayers.Layer.Vector("Tiles Layer",{strategies:[t],styleMap:n,visibility:!0}),this._map.addLayer(this._tilesLayer),this._tilesLayer.setOpacity(.3)},getTileSize:function(){var e=this.tileStrategy.getGrid().grid;return this.tileSize=null,e&&(this.tileSize={},this.tileSize.width=e[0][0].size.w,this.tileSize.height=e[0][0].size.h),this.tileSize},getGrid:function(){var e=null;this.tileStrategy.update();var t=this.tileStrategy.getGrid().grid;if(t){e={rows:t.length,columns:t[0].length,bounds:[]};for(var n=0,r=t.length;n<r;n++){var i=t[n];for(var s=0,o=i.length;s<o;s++){var u=i[s];if(typeof u.bounds.left=="undefined"||typeof u.bounds.bottom=="undefined"||typeof u.bounds.right=="undefined"||typeof u.bounds.top=="undefined")return null;var a=[];a[0]=u.bounds.left,a[1]=u.bounds.bottom,a[2]=u.bounds.right,a[3]=u.bounds.top,e.bounds.push(a)}}}return e},getPrintTiles:function(){return this._printTiles},setPrintTile:function(e,t,n){typeof this._printTiles[e.getId()]=="undefined"&&(this._printTiles[e.getId()]=[]),this._printTiles[e.getId()].push({bbox:t,url:n})},refreshCaches:function(){this._tileData.purgeOffset(24e4),this._tileDataTemp.purgeOffset(24e4)},getNonCachedGrid:function(e,t){var n=this.getSandbox().findMapLayerFromSelectedMapLayers(e),r=n.getCurrentStyle().getName(),i=[];for(var s=0;s<t.bounds.length;s++){var o=t.bounds[s].join(","),u=this._tileData.mget(e,r,o);u||i.push(t.bounds[s])}return i},deleteTileCache:function(e,t){this._tileData.mdel(e,t),this._tileDataTemp.mdel(e,t)},isWFSOpen:function(){return this._isWFSOpen>0?!0:!1},getLayerCount:function(){return this._isWFSOpen},isArrayEqual:function(e,t){if(t.length!=e.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!=t[n])return!1;return!0},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization("MapWfs2")),e?this._localization[e]:this._localization},showErrorPopup:function(e,t,n){if(n==1)if(this.errorTriggers[e]){if(this.errorTriggers[e].count>=this.errorTriggers[e].limit)return;this.errorTriggers[e].count++}else{if(this.errorTriggers[e+"_"+t.getId()])return;this.errorTriggers[e+"_"+t.getId()]=!0}var r=Oskari.clazz.create("Oskari.userinterface.component.Popup"),i=this.getLocalization("error").title,s=this.getLocalization("error")[e];t&&(s=s.replace(/\{layer\}/,t.getName()));var o=r.createCloseButton(this.getLocalization().button.close);o.addClass("primary"),r.addClass("error_handling"),r.show(i,s,[o]),r.fadeout(5e3)},getAllFeatureIds:function(e){var t=e.getClickedFeatureIds().slice(0);for(var n=0;n<e.getSelectedFeatures().length;++n)t.push(e.getSelectedFeatures()[n][0]);return t},getHighlightImage:function(e,t,n,r,i){var s=function(e,t){for(var n=0;n<e.length;n++)if(e[n]==t)return!0;return!1};s(this.activeHighlightLayers,e)||this.activeHighlightLayers.push(e);var o={width:this.getSandbox().getMap().getWidth(),height:this.getSandbox().getMap().getHeight()},u="?layerId="+e.getId()+"&session="+this.getIO().getSessionID()+"&type="+"highlight"+"&srs="+t+"&bbox="+n.join(",")+"&zoom="+r+"&featureIds="+i.join(",")+"&width="+o.width+"&height="+o.height,a=this.getIO().getRootURL()+"/image"+u,f=this.getSandbox().getEventBuilder("WFSImageEvent")(e,a,n,o,"highlight",!1,!1);this.getSandbox().notifyAll(f)}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),define("bundles/framework/bundle/mapwfs2/plugin/WfsLayerPlugin",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs2.event.WFSFeatureEvent",function(e,t){this._layer=e,this._feature=t},{__name:"WFSFeatureEvent",getName:function(){return this.__name},getLayer:function(){return this._layer},getFeature:function(){return this._feature}},{protocol:["Oskari.mapframework.event.Event"]}),define("bundles/framework/bundle/mapwfs2/event/WFSFeatureEvent",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs2.event.WFSFeaturesSelectedEvent",function(e,t,n){this._wfsFeatureIds=e,this._addToSelection=n,this._mapLayer=t},{__name:"WFSFeaturesSelectedEvent",getName:function(){return this.__name},getWfsFeatureIds:function(){return this._wfsFeatureIds},isKeepSelection:function(){return this._addToSelection?this._addToSelection:!1},getMapLayer:function(){return this._mapLayer}},{protocol:["Oskari.mapframework.event.Event"]}),define("bundles/framework/bundle/mapwfs2/event/WFSFeaturesSelectedEvent",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs2.event.WFSImageEvent",function(e,t,n,r,i,s,o){this._layer=e,this._imageUrl=t,this._bbox=n,this._size=r,this._layerType=i,this._boundaryTile=s,this._keepPrevious=o},{__name:"WFSImageEvent",getName:function(){return this.__name},getLayer:function(){return this._layer},getImageUrl:function(){return this._imageUrl},getBBOX:function(){return this._bbox},getSize:function(){return this._size},getLayerType:function(){return this._layerType},isBoundaryTile:function(){return this._boundaryTile},isKeepPrevious:function(){return this._keepPrevious}},{protocol:["Oskari.mapframework.event.Event"]}),define("bundles/framework/bundle/mapwfs2/event/WFSImageEvent",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs2.event.WFSPropertiesEvent",function(e,t,n){this._layer=e,this._locales=t,this._fields=n},{__name:"WFSPropertiesEvent",getName:function(){return this.__name},getLayer:function(){return this._layer},getLocales:function(){return this._locales},getFields:function(){return this._fields}},{protocol:["Oskari.mapframework.event.Event"]}),define("bundles/framework/bundle/mapwfs2/event/WFSPropertiesEvent",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs2.request.ShowOwnStyleRequest",function(e){this._id=e},{__name:"ShowOwnStyleRequest",getName:function(){return this.__name},getId:function(){return this._id}},{protocol:["Oskari.mapframework.request.Request"]}),define("bundles/framework/bundle/mapwfs2/request/ShowOwnStyleRequest",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs2.request.ShowOwnStyleRequestHandler",function(e){this.plugin=e,this.localization=e.getLocalization("popup"),this.visualizationForm=this.plugin.getVisualizationForm(),this.template={};for(p in this.__templates)this.template[p]=jQuery(this.__templates[p])},{__templates:{wrapper:"<div></div>",toolsButton:'<div style= "display: inline-block; border: 1px solid;"></div>',link:'<div class="link"><a href="javascript:void(0);"></a></div></div>'},handleRequest:function(e,t){var n=t.getId(),r=this.plugin.getSandbox().findMapLayerFromSelectedMapLayers(n),i=r.getCustomStyle();i&&this.visualizationForm.setValues(i);var s=Oskari.clazz.create("Oskari.userinterface.component.Popup"),o=this.localization.title,u=this.template.wrapper.clone();u.append(this.visualizationForm.getForm());var a=this,f=Oskari.clazz.create("Oskari.userinterface.component.Button");f.setTitle(this.localization.button.save),f.addClass("primary saveOwnStyle"),f.setHandler(function(){var e="oskari_custom";a.plugin.deleteTileCache(n,e);var t=a.visualizationForm.getValues();r.setCustomStyle(t),a.plugin.setCustomStyle(n,t),r.selectStyle(e);var i=a.plugin.getSandbox().getEventBuilder("MapLayerEvent")(n,"update");a.plugin.getSandbox().notifyAll(i),s.close()});var l=Oskari.clazz.create("Oskari.userinterface.component.Button");l.setTitle(this.localization.button.cancel),l.setHandler(function(){s.close()}),s.addClass("wfs_own_style"),s.show(o,u,[l,f])}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),define("bundles/framework/bundle/mapwfs2/request/ShowOwnStyleRequestHandler",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs2.domain.QueuedTile",function(e){for(p in e)this[p]=e[p]},{getBounds:function(){return this.bounds}}),define("bundles/framework/bundle/mapwfs2/domain/QueuedTile",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs2.domain.TileQueue",function(){this.queue=[]},{getQueue:function(){return this.queue},getLength:function(){return this.queue.length},popJob:function(){var e=this.queue,t=e.length;if(t===0)return null;if(t<4)return e.shift(-1);var n=null,r=Math.floor(t/2);return n=e[r],this.queue=e.slice(0,r).concat(e.slice(r+1)),n},pushJob:function(e){this.queue.push(e)},flushQueue:function(){this.queue=[]}}),define("bundles/framework/bundle/mapwfs2/domain/TileQueue",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs2.domain.WFSLayer",function(){this._layerType="WFS",this._featureData=!0,this._fields=[],this._locales=[],this._activeFeatures=[],this._selectedFeatures=[],this._clickedFeatureIds=[],this._clickedFeatureListIds=[],this._propertyTypes={},this._styles=[],this._customStyle=null,this.localization=Oskari.getLocalization("MapWfs2")},{getFields:function(){return this._fields},setFields:function(e){this._fields=e},getLocales:function(){return this._locales},setLocales:function(e){this._locales=e},getActiveFeatures:function(){return this._activeFeatures},setActiveFeature:function(e){this._activeFeatures.push(e)},setActiveFeatures:function(e){this._activeFeatures=e},getSelectedFeatures:function(){return this._selectedFeatures},setSelectedFeature:function(e){this._selectedFeatures.push(e)},setSelectedFeatures:function(e){this._selectedFeatures=e},getClickedFeatureIds:function(){return this._clickedFeatureIds},setClickedFeatureId:function(e){this._clickedFeatureIds.push(e)},setClickedFeatureIds:function(e){this._clickedFeatureIds=e},getClickedFeatureListIds:function(){return this._clickedFeatureListIds},setClickedFeatureListId:function(e){this._clickedFeatureListIds.push(e)},setClickedFeatureListIds:function(e){this._clickedFeatureListIds=e},setPropertyTypes:function(e){this._propertyTypes=e},getPropertyTypes:function(){return this._propertyTypes},getLegendImage:function(){return null},setCustomStyle:function(e){this._customStyle=e},getCustomStyle:function(){return this._customStyle},getStyles:function(){if(this.getCustomStyle()){var e=this.localization["own-style"],t=Oskari.clazz.create("Oskari.mapframework.domain.Style");return t.setName("oskari_custom"),t.setTitle(e),t.setLegend(""),this._styles.concat([t])}return this._styles}},{extend:["Oskari.mapframework.domain.AbstractLayer"]}),define("bundles/framework/bundle/mapwfs2/domain/WFSLayer",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs2.domain.WfsLayerModelBuilder",function(e){this.localization=Oskari.getLocalization("MapWfs2"),this.sandbox=e},{parseLayerData:function(e,t,n){var r=this,i=Oskari.clazz.builder("Oskari.mapframework.domain.Tool");if(e.isLayerOfType("WFS")){var s=this.localization["own-style"],o=i();o.setName("ownStyle"),o.setTitle(s),o.setTooltip(s),o.setCallback(function(){r.sandbox.postRequestByName("ShowOwnStyleRequest",[e.getId()])}),e.addTool(o)}var u=this.localization["object-data"],a=i();a.setName("objectData"),a.setTitle(u),a.setTooltip(u),a.setCallback(function(){r.sandbox.postRequestByName("ShowFeatureDataRequest",[e.getId()])}),e.addTool(a);var f=this.localization["default-style"],l=Oskari.clazz.create("Oskari.mapframework.domain.Style");l.setName("default"),l.setTitle(f),l.setLegend("");if(t.styles&&t.styles.length>0)for(var c=0;c<t.styles.length;c++)if(t.styles[c].name==="default"){t.styles[c].title=f;break}n.populateStyles(e,t,l)}}),define("bundles/framework/bundle/mapwfs2/domain/WfsLayerModelBuilder",function(){}),Oskari.registerLocalization({lang:"fi",key:"MapWfs2",value:{title:"MapWfs2",desc:"","object-data":"Kohdetiedot","default-style":"Oletustyyli","own-style":"Oma tyyli",tile:{title:"MapWfs2"},flyout:{title:"MapWfs2",message:"MapWfs2"},error:{title:"Virhe",connection_not_available:"Yhteyttä ei voitu muodostaa WFS-taustapalveluun.",connection_broken:"Yhteys WFS-taustapalveluun katkesi.",wfs_no_permissions:"WFS-tasoon ({layer}) ei ole riittäviä oikeuksia.",wfs_configuring_layer_failed:"WFS-tason ({layer}) konfigurointi epäonnistui.",wfs_request_failed:"WFS-tason ({layer}) WFS-kysely epäonnistui.",features_parsing_failed:"WFS-tason ({layer}) featureiden käsittely epäonnistui."},button:{cancel:"Peruuta",show:"Näytä kohteet",close:"Sulje",edit:"Muokkaa"},popup:{title:"Oma tyyli",button:{cancel:"Peruuta",save:"Tallenna"}}}}),define("bundles/framework/bundle/mapwfs2/locale/fi",function(){}),Oskari.registerLocalization({lang:"sv",key:"MapWfs2",value:{title:"MapWfs2",desc:"","object-data":"Objektuppgifter","default-style":"Standard stil","own-style":"Egen stil",tile:{title:"MapWfs2"},flyout:{title:"MapWfs2",message:"MapWfs2"},error:{title:"Felmeddelande",connection_not_available:"Kontakt med WFS-bakgrundstjänsten fås inte.",connection_broken:"Kontakten med WFS-bakgrundstjänsten har avbrutits.",wfs_no_permissions:"Rättigheter till WFS-lager ({layer}) saknas.",wfs_configuring_layer_failed:"Konfigureringen av WFS-lager ({layer}) misslyckades.",wfs_request_failed:"Din förfrågan för WFS-lager ({layer}) misslyckades.",features_parsing_failed:"Hanteringen av features i WFS-lager ({layer}) misslyckades."},button:{cancel:"Avbryt",show:"Visa",close:"Stäng",edit:"Redigera"},popup:{title:"Egen stil",button:{cancel:"Avbryt",save:"Lagra"}}}}),define("bundles/framework/bundle/mapwfs2/locale/sv",function(){}),Oskari.registerLocalization({lang:"en",key:"MapWfs2",value:{title:"MapWfs2",desc:"","object-data":"Object data","default-style":"Default style","own-style":"Own style",tile:{title:"MapWfs2"},flyout:{title:"MapWfs2",message:"MapWfs2"},error:{title:"Error",connection_not_available:"Connection to the WFS background service is not available.",connection_broken:"Connection to the WFS background service broke down.",wfs_no_permissions:"No permission to use WFS layer ({layer}).",wfs_configuring_layer_failed:"Configuring WFS layer ({layer}) failed.",wfs_request_failed:"WFS layer's ({layer}) request failed.",features_parsing_failed:"Feature parsing of WFS layer ({layer}) failed."},button:{cancel:"Cancel",show:"View places",close:"Close",edit:"Edit"},popup:{title:"Own style",button:{cancel:"Cancel",save:"Save"}}}}),define("bundles/framework/bundle/mapwfs2/locale/en",function(){}),Oskari.registerLocalization({lang:"es",key:"MapWfs2",value:{title:"MapWfs2",desc:"","object-data":"Object data","default-style":"Default style","own-style":"Own style",tile:{title:"MapWfs2"},flyout:{title:"MapWfs2",message:"MapWfs2"},error:{title:"Error",connection_not_available:"Connection to the WFS background service is not available.",connection_broken:"Connection to the WFS background service broke down.",wfs_no_permissions:"No permission to use WFS layer ({layer}).",wfs_configuring_layer_failed:"Configuring WFS layer ({layer}) failed.",wfs_request_failed:"WFS layer's ({layer}) request failed.",features_parsing_failed:"Feature parsing of WFS layer ({layer}) failed."},button:{cancel:"Cancel",show:"View places",close:"Close",edit:"Edit"},popup:{title:"Own style",button:{cancel:"Cancel",save:"Save"}}}}),define("bundles/framework/bundle/mapwfs2/locale/es",function(){}),Oskari.registerLocalization({lang:"de",key:"MapWfs2",value:{title:"MapWfs2",desc:"","object-data":"Object data","default-style":"Default style","own-style":"Own style",tile:{title:"MapWfs2"},flyout:{title:"MapWfs2",message:"MapWfs2"},error:{title:"Error",connection_not_available:"Connection to the WFS background service is not available.",connection_broken:"Connection to the WFS background service broke down.",wfs_no_permissions:"No permission to use WFS layer ({layer}).",wfs_configuring_layer_failed:"Configuring WFS layer ({layer}) failed.",wfs_request_failed:"WFS layer's ({layer}) request failed.",features_parsing_failed:"Feature parsing of WFS layer ({layer}) failed."},button:{cancel:"Cancel",show:"View places",close:"Close",edit:"Edit"},popup:{title:"Own style",button:{cancel:"Cancel",save:"Save"}}}}),define("bundles/framework/bundle/mapwfs2/locale/de",function(){}),Oskari.registerLocalization({lang:"cs",key:"MapWfs2",value:{title:"MapWfs2",desc:"","object-data":"Object data","default-style":"Default style","own-style":"Own style",tile:{title:"MapWfs2"},flyout:{title:"MapWfs2",message:"MapWfs2"},error:{title:"Error",connection_not_available:"Connection to the WFS background service is not available.",connection_broken:"Connection to the WFS background service broke down.",wfs_no_permissions:"No permission to use WFS layer ({layer}).",wfs_configuring_layer_failed:"Configuring WFS layer ({layer}) failed.",wfs_request_failed:"WFS layer's ({layer}) request failed.",features_parsing_failed:"Feature parsing of WFS layer ({layer}) failed."},button:{cancel:"Cancel",show:"View places",close:"Close",edit:"Edit"},popup:{title:"Own style",button:{cancel:"Cancel",save:"Save"}}}}),define("bundles/framework/bundle/mapwfs2/locale/cs",function(){}),define("src/framework/mapwfs2/module",["oskari","jquery","bundles/framework/bundle/mapwfs2/comp","libraries/jquery/plugins/jquery.cookie","bundles/framework/bundle/mapwfs2/service/Connection","bundles/framework/bundle/mapwfs2/service/Mediator","bundles/framework/bundle/mapwfs2/plugin/QueuedTilesGrid","bundles/framework/bundle/mapwfs2/plugin/QueuedTilesStrategy","bundles/framework/bundle/mapwfs2/plugin/TileCache","bundles/framework/bundle/mapwfs2/plugin/WfsLayerPlugin","bundles/framework/bundle/mapwfs2/event/WFSFeatureEvent","bundles/framework/bundle/mapwfs2/event/WFSFeaturesSelectedEvent","bundles/framework/bundle/mapwfs2/event/WFSImageEvent","bundles/framework/bundle/mapwfs2/event/WFSPropertiesEvent","bundles/framework/bundle/mapwfs2/request/ShowOwnStyleRequest","bundles/framework/bundle/mapwfs2/request/ShowOwnStyleRequestHandler","bundles/framework/bundle/mapwfs2/domain/QueuedTile","bundles/framework/bundle/mapwfs2/domain/TileQueue","bundles/framework/bundle/mapwfs2/domain/WFSLayer","bundles/framework/bundle/mapwfs2/domain/WfsLayerModelBuilder","bundles/framework/bundle/mapwfs2/locale/fi","bundles/framework/bundle/mapwfs2/locale/sv","bundles/framework/bundle/mapwfs2/locale/en","bundles/framework/bundle/mapwfs2/locale/es","bundles/framework/bundle/mapwfs2/locale/de","bundles/framework/bundle/mapwfs2/locale/cs"],function(e,t){return e.bundleCls("mapwfs2").category({create:function(){return this},update:function(e,t,n,r){}})});